<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visual Audit: Kala Ghoda Heritage</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover' />
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --bg: #ffffff;
            --text-main: #222;
            --text-sub: #555;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --accent-wall: #c0392b; 
            --accent-nav: #2980b9; 
            --gold-text: #cfa842; 
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        body { margin: 0; padding: 0; font-family: 'Lato', sans-serif; overflow: hidden; background: #f4f4f4; -webkit-tap-highlight-color: transparent; }
        
        #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        .maplibregl-canvas-container canvas { filter: sepia(0.1) contrast(0.95); transition: filter 0.5s ease; }
        
        /* 1883 Map Mode Styling */
        body.mode-1883 #map canvas { filter: grayscale(1) contrast(0.9) brightness(1.1) !important; }
        body.mode-1883 .filter-btn:not(#btn-1883) { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        body.mode-1883 #search-container { opacity: 0.4; pointer-events: none; }

        /* --- UI: HEADER (Desktop Default) --- */
        #header {
            position: absolute; top: 20px; left: 20px; 
            width: 340px; background: var(--bg); z-index: 100;
            box-shadow: var(--shadow); border: 1px solid var(--border); border-radius: 8px; 
            display: flex; flex-direction: column;
            max-height: 85vh; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #header h1 { font-family: 'Cardo', serif; padding: 20px 20px 5px 20px; margin: 0; line-height: 1.2; }
        .title-sub { display: block; font-size: 13px; font-weight: 900; color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .title-main { display: block; font-size: 28px; font-weight: 400; color: var(--gold-text); margin-top: 5px; }
        #header h2 { font-family: 'Lato', sans-serif; font-size: 10px; color: #aaa; padding: 0 20px 15px 20px; margin: 0; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; border-bottom: 1px solid var(--border); }

        /* --- UI: SEARCH --- */
        #search-container { position: relative; padding: 15px 20px 5px 20px; }
        .search-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
        #search-input { width: 100%; padding: 12px 10px 12px 40px; font-family: 'Lato', sans-serif; font-size: 14px; border: 1px solid #ddd; background: #fafafa; outline: none; border-radius: 6px; transition: all 0.2s; height: 44px; box-sizing: border-box; }
        #search-input:focus { border-color: #333; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .search-icon { position: absolute; left: 14px; color: #999; font-size: 14px; pointer-events: none; }
        
        #search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--border); border-top: none; max-height: 250px; overflow-y: auto; z-index: 110; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 0 0 6px 6px; }
        .search-item { padding: 14px 14px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; flex-direction: column; }
        .search-item:hover { background: #f9f9f9; }
        .search-item-title { font-weight: 700; font-size: 13px; color: #333; }
        .search-item-cat { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 2px; }

        /* --- UI: LAYERS LIST --- */
        #console { padding: 0 20px 20px 20px; display: flex; flex-direction: column; }
        #layers-header { 
            padding: 15px 0 10px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
            font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: #444; user-select: none;
        }
        #layers-header:hover { color: #000; }
        #layers-arrow { transition: transform 0.3s ease; }
        #layers-arrow.rotated { transform: rotate(180deg); }
        
        #layers-content { display: flex; flex-wrap: wrap; gap: 8px; overflow: hidden; transition: max-height 0.4s ease; max-height: 2000px; }
        #layers-content.collapsed { max-height: 0; margin-top: 0; }

        /* --- FILTER BUTTONS --- */
        .filter-btn { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 8px 0 12px; 
            width: 100%; height: 38px; /* Fixed height for consistency */
            font-size: 11px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; 
            border: 1px solid #e0e0e0; background: #fff; color: #555; cursor: pointer; border-radius: 6px; 
            transition: all 0.2s; box-sizing: border-box;
        }
        .filter-btn:hover { border-color: #bbb; color: #000; background: #f9f9f9; }
        .layer-label-group { display: flex; align-items: center; gap: 10px; pointer-events: none; flex: 1; }
        
        /* The SOLO Button */
        .layer-solo-btn {
            font-size: 9px; background: #f0f0f0; color: #999;
            padding: 4px 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s;
            height: 20px; display: flex; align-items: center;
        }
        .layer-solo-btn:hover { background: var(--accent-nav); color: #fff; }

        /* Desktop: Hide SOLO until hover to reduce clutter */
        @media (min-width: 769px) {
            .layer-solo-btn { opacity: 0; transform: translateX(5px); }
            .filter-btn:hover .layer-solo-btn { opacity: 1; transform: translateX(0); }
        }
        
        /* Visibility States */
        .filter-btn.layer-hidden { opacity: 0.6; background: #f4f4f4; color: #aaa; }
        .filter-btn.layer-hidden .dot-indicator { background: #ccc !important; }
        .filter-btn.layer-hidden .layer-eye { color: #ccc; }
        .layer-eye { width: 16px; text-align: center; }
        .dot-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: currentColor; }

        .filter-btn.all-layers-btn { justify-content: center; background: #222; color: #fff; }
        .filter-btn.all-layers-btn:hover { background: #444; }

        .console-separator { width: 100%; border-bottom: 1px solid #eee; margin: 10px 0; height: 1px; }

        #wall-info { display: none; margin-top: 8px; padding: 10px; background: #fff4f4; border-left: 3px solid var(--accent-wall); font-size: 11px; color: #555; line-height: 1.4; border-radius: 2px; width: 100%; box-sizing: border-box; }
        #wall-info strong { display: block; margin-bottom: 3px; color: var(--accent-wall); text-transform: uppercase; font-weight: 800; font-size: 10px; }

        /* --- UI: TIME SLIDER --- */
        #time-controls {
            padding: 15px 15px; border: 1px solid #eee; margin-top: 5px;
            display: none; flex-direction: column; background: #fcfcfc; border-radius: 4px;
            width: 100%; flex-basis: 100%; box-sizing: border-box;
        }
        #time-controls.active { display: flex; }
        .range-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-bottom: 5px; font-weight: 700; }
        #year-display { text-align: center; font-family: 'Cardo', serif; font-size: 18px; color: var(--accent-wall); margin-bottom: 10px; font-weight: bold; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0; height: 30px; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; margin-top: 12px; }
        input[type=range]::-webkit-slider-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--gold-text); cursor: pointer; -webkit-appearance: none; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 2px solid #fff; }

        /* --- UI: MARKERS & TOOLTIPS --- */
        .marker { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; font-size: 14px; color: #fff; transition: transform 0.2s ease; z-index: 10; background-size: cover; }
        .marker:hover { transform: scale(1.15); z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .marker.selected { transform: scale(1.3); z-index: 30; box-shadow: 0 0 0 3px #fff, 0 8px 20px rgba(0,0,0,0.3); }
        #tooltip { position: absolute; pointer-events: none; background: #111; color: #fff; padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; border-radius: 4px; opacity: 0; z-index: 500; white-space: nowrap; transform: translate(-50%, -10px); transition: opacity 0.2s; }

        /* --- UI: SIDE PANEL (Bottom Sheet) --- */
        #side-panel { 
            position: fixed; right: -450px; top: 0; bottom: 0; width: 400px; 
            background: #fff; z-index: 200; box-shadow: -10px 0 30px rgba(0,0,0,0.1); 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex; flex-direction: column; border-left: 1px solid var(--border);
        }
        #side-panel.open { transform: translateX(-450px); }
        #panel-scroll-area { flex: 1; overflow-y: auto; }
        .panel-img-container { width: 100%; height: 260px; background: #eee; }
        .panel-img { width: 100%; height: 100%; object-fit: cover; }
        .panel-content { padding: 25px 30px; }
        .panel-cat { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; color: #999; margin-bottom: 10px; display: inline-block; }
        .panel-title { font-family: 'Cardo', serif; font-size: 28px; margin-bottom: 15px; line-height: 1.1; color: #111; }
        .panel-desc { line-height: 1.6; color: #444; font-size: 15px; margin-bottom: 25px; }
        .panel-info { display: table; width: 100%; border-top: 1px solid #eee; padding-top: 20px; }
        .panel-info-row { display: table-row; }
        .panel-info-label { display: table-cell; padding: 8px 0; font-size: 10px; text-transform: uppercase; color: #999; letter-spacing: 1px; width: 30%; font-weight: 700; }
        .panel-info-val { display: table-cell; padding: 8px 0; font-size: 13px; color: #222; font-weight: 400; }
        
        .panel-close { 
            position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; 
            background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 50%; 
            cursor: pointer; font-size: 20px; z-index: 300; display: flex; align-items: center; justify-content: center;
        }
        .panel-close:hover { background: #000; }
        .panel-action-btn { display: block; width: 100%; margin-top: 20px; padding: 14px 0; text-align: center; text-decoration: none; background: var(--accent-nav); color: #fff; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-radius: 6px; }

        /* --- UI: CONTROLS --- */
        #vertical-controls { position: fixed; right: 20px; bottom: 30px; display: flex; flex-direction: column; gap: 8px; z-index: 95; }
        .v-control-btn { 
            width: 40px; height: 40px; border: none; background: #fff; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; 
            color: #555; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .v-control-btn:hover { background: #111; color: #fff; }
        .v-control-btn.active-3d { background: #111; color: #fff; }
        
        .maplibregl-ctrl-top-right { display: none !important; }
        .maplibregl-ctrl-scale { background-color: rgba(255, 255, 255, 0.9) !important; border: 1px solid var(--border) !important; color: #333 !important; font-family: 'Lato', sans-serif !important; font-size: 10px !important; border-radius: 2px !important; box-shadow: none !important; }

        /* ================= MOBILE MODE ================= */
        @media (max-width: 768px) {
            /* Mobile Header: Floating Search Bar */
            #header { 
                top: 15px; left: 15px; right: 15px; width: auto; 
                max-height: none; background: transparent; box-shadow: none; border: none;
                overflow: visible;
            }
            #header h1, #header h2 { display: none; } /* Hide title to save space */
            
            #search-container { padding: 0; background: transparent; display: flex; gap: 10px; }
            .search-wrapper { flex: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; background: #fff; }
            #search-input { height: 50px; font-size: 16px; border: none; }
            .search-icon { font-size: 16px; top: 17px; }
            #search-results { left: 0; right: 0; top: 55px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            
            /* Mobile "Filter" Toggle Button (New Element we will add in JS) */
            #mobile-filter-toggle {
                display: flex !important; width: 50px; height: 50px; flex-shrink: 0;
                background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                align-items: center; justify-content: center; font-size: 18px; color: #333;
                cursor: pointer; transition: all 0.2s;
            }

            /* Console (Layers) becomes a Bottom Sheet Drawer */
            #console {
                position: fixed; left: 0; right: 0; bottom: 0;
                background: #fff; border-radius: 20px 20px 0 0;
                box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
                padding: 20px; z-index: 150;
                transform: translateY(110%); /* Hidden by default */
                transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                max-height: 70vh; overflow-y: auto;
                padding-bottom: calc(20px + var(--safe-area-bottom));
            }
            #console.open { transform: translateY(0); }
            
            /* Add a "Handle" to the drawer */
            #console::before {
                content: ''; display: block; width: 40px; height: 5px; 
                background: #ddd; margin: 0 auto 15px auto; border-radius: 3px;
            }

            /* Force Expand Layers in Mobile Drawer */
            #layers-content { max-height: none !important; opacity: 1; margin-top: 10px; }
            #layers-header { display: none; } /* Hide the 'Filter Layers' text/arrow */

            /* Bigger Touch Targets for Mobile */
            .filter-btn { height: 50px; font-size: 13px; margin-bottom: 8px; }
            .layer-solo-btn {
                opacity: 1 !important; transform: none !important;
                height: 30px; padding: 0 12px; font-size: 10px;
                background: #f0f0f0; border: 1px solid #ddd;
            }
            
            /* Side Panel (Details) */
            #side-panel { 
                right: auto; left: 0; top: auto; bottom: 0; width: 100%; 
                height: 80vh; transform: translateY(110%); border-radius: 20px 20px 0 0; 
                border-top: 1px solid #eee; border-left: none;
            }
            #side-panel.open { transform: translateY(0); }
            .panel-close { top: 20px; right: 20px; background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            
            /* Vertical Controls Position */
            #vertical-controls { bottom: 30px; right: 15px; }
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="tooltip"></div> 
    
    <div id="header">
        <h1>
            <span class="title-sub">Visual Audit</span>
            <span class="title-main">Kala Ghoda</span>
        </h1>
        <h2>Heritage Survey</h2>
        
        <div id="search-container">
            <div class="search-wrapper">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Search buildings, styles..." autocomplete="off">
            </div>
            <div id="search-results"></div>
            </div>

        <div id="console">
            <div id="layers-header">
                <span><i class="fa-solid fa-layer-group"></i> Filter Layers</span>
                <i class="fa-solid fa-chevron-down" id="layers-arrow"></i>
            </div>
            
            <div id="layers-content" class="collapsed">
            </div>
        </div>
    </div>

    <div id="vertical-controls">
        <button class="v-control-btn" id="zoom-in-btn" title="Zoom In"><i class="fa-solid fa-plus"></i></button>
        <button class="v-control-btn" id="zoom-out-btn" title="Zoom Out"><i class="fa-solid fa-minus"></i></button>
        <button class="v-control-btn" id="compass-btn" title="North"><i class="fa-regular fa-compass"></i></button>
        <button class="v-control-btn" id="view-3d-btn" title="Toggle 3D"><i class="fa-solid fa-cube"></i></button>
        <button class="v-control-btn" id="reset-view-btn" title="Reset View"><i class="fa-solid fa-compress"></i></button>
        <button class="v-control-btn" id="locate-btn" title="My Location"><i class="fa-solid fa-location-crosshairs"></i></button>
    </div>

    <div id="side-panel">
        <button class="panel-close" id="close-btn">×</button>
        <div id="panel-scroll-area">
            <div id="panel-inner"></div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            initMap();
        });

        function initMap() {
            var initialZoom = window.innerWidth < 768 ? 15.0 : 16.5;

            var config = {
                style: 'https://api.maptiler.com/maps/019b6fe6-78c4-7dcb-b6eb-fed1b18171df/style.json?key=f0f0aibL2C05fTzSrqHq', 
                colors: { 'Art Deco': '#2a9d8f', 'Victorian': '#e76f51', 'Modern': '#264653', 'Lettering': '#7b2cbf', 'Ghost Site': '#95a5a6', 'Street Furniture': '#4a69bd', 'Living Heritage': '#27ae60' },
                icons: { 'Art Deco': 'fa-building', 'Victorian': 'fa-landmark', 'Modern': 'fa-square', 'Lettering': 'fa-font', 'Ghost Site': 'fa-ghost', 'Street Furniture': 'fa-road', 'Living Heritage': 'fa-users' },
                chapters: [
                    { id: 'regal', category: 'Art Deco', title: 'Regal Cinema', image: './images/regal.jpg', description: 'One of the earliest Art Deco cinemas in India.', year: '1933', architect: 'Charles Stevens', builder: 'Framji Sidhwa', location: { center: [72.8325, 18.9246] } },
                    { id: 'museum', category: 'Victorian', title: 'CSMVS Museum', image: './images/csmvs.jpg', description: 'Indo Saracenic landmark constructed using grey Kurla basalt.', year: '1914', architect: 'George Wittet', builder: 'Govt. of Bombay', location: { center: [72.8322, 18.9269] } },
                    { id: 'elphinstone', category: 'Victorian', title: 'Elphinstone College', image: './images/elphinstone.jpg', description: 'Victorian Gothic Revival building with pointed arches.', year: '1871', architect: 'James Trubshawe', builder: 'Unknown', location: { center: [72.8309, 18.9271] } },
                    { id: 'sassoon', category: 'Victorian', title: 'David Sassoon Library', image: './images/sassoon.jpg', description: 'Victorian Gothic architecture defined by pointed arches.', year: '1870', architect: 'Campbell & Gosling', builder: 'Scott McClelland', location: { center: [72.8311, 18.9277] } },
                    { id: 'army', category: 'Victorian', title: 'Army and Navy Building', image: './images/army-navy.jpg', description: 'Late nineteenth century Neo Classical commercial building.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8313, 18.9282] } },
                    { id: 'esplanade', category: 'Victorian', title: 'Esplanade Mansion', image: './images/esplanade.jpg', description: 'Formerly Watson\'s Hotel. One of the earliest cast iron framed buildings.', year: '1865', architect: 'Rowland Mason Ordish', builder: 'British Engineers', location: { center: [72.8311, 18.9283] } },
                    { id: 'jehangir', category: 'Modern', title: 'Jehangir Art Gallery', image: './images/jehangir.jpg', description: 'Modernist concrete structure with a distinctive cantilevered entrance.', year: '1952', architect: 'G. M. Bhuta', builder: 'Sir Cowasji Jehangir', location: { center: [72.8317, 18.9275] } },
                    { id: 'statue', category: 'Street Furniture', title: 'Kala Ghoda Statue', image: './images/placeholder.jpg', description: 'Bronze statue installed to mark the historic site.', year: '2017', architect: 'Commissioned artwork', builder: 'Kala Ghoda Association', location: { center: [72.8318, 18.9279] } },
                    { id: 'synagogue', category: 'Victorian', title: 'Keneseth Eliyahoo', image: './images/synagogue.jpg', description: 'Victorian era synagogue built for the Baghdadi Jewish community.', year: '1884', architect: 'Unknown', builder: 'Jewish Community', location: { center: [72.8326, 18.9281] } },
                    { id: 'ropewalk', category: 'Street Furniture', title: 'Rope Walk Lane', image: './images/ropewalk.jpg', description: 'Historic lane characterised by enamel street signage.', year: '19th century', architect: 'Incremental', builder: 'Multiple', location: { center: [72.8323, 18.9278] } },
                    { id: 'army-lettering', category: 'Lettering', title: 'Army and Navy Signage', image: './images/army-lettering.jpg', description: 'Original carved and painted serif lettering.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8313, 18.9282] } },
                    { id: 'ropewalk-signs', category: 'Lettering', title: 'Rope Walk Signs', image: './images/ropewalk-lettering.jpg', description: 'Blue enamel street signage with bilingual lettering.', year: '20th century', architect: 'Municipal signage', builder: 'BMC', location: { center: [72.8323, 18.9278] } },
                    { id: 'lumiere', category: 'Ghost Site', title: 'Lumière Screening Site', image: './images/lumiere-placeholder.jpg', description: 'On July 7, 1896, the Lumière Brothers screened the first motion pictures.', year: '1896', architect: 'N/A', builder: 'Historic Event', location: { center: [72.83125, 18.92835] } },
                    { id: 'hydrant', category: 'Street Furniture', title: 'British Fire Hydrant', image: './images/hydrant.jpg', description: 'A cast-iron fire hydrant from the Bombay Municipal Corporation era.', year: 'Late 19th C.', architect: 'BMC', builder: 'Foundry Cast', location: { center: [72.8325, 18.9276] } },
                    { id: 'pavement', category: 'Living Heritage', title: 'The Pavement Gallery', image: './images/pavement.jpg', description: 'An informal exhibition space where aspiring artists display their work.', year: 'Ongoing', architect: 'The People', builder: 'Informal Usage', location: { center: [72.8316, 18.9275] } },
                    { id: 'booksellers', category: 'Living Heritage', title: 'Secondhand Book Sellers', image: './images/books.jpg', description: 'The lineage of street book vendors near Flora Fountain.', year: 'Mid 20th C.', architect: 'N/A', builder: 'Vendor Collective', location: { center: [72.8305, 18.9290] } },
                    { id: 'kerbstones', category: 'Street Furniture', title: 'Kurla Basalt Kerbstones', image: './images/kerb.jpg', description: 'Original massive blocks of grey Kurla basalt lining the pavement.', year: '19th Century', architect: 'City Engineers', builder: 'Public Works', location: { center: [72.8320, 18.9275] } },
                    { id: 'rhythm', category: 'Ghost Site', title: 'Rhythm House', image: './images/rhythm-house.jpg', description: 'Formerly the city\'s premier music store.', year: '1940s', architect: 'Unknown', builder: 'Mehmood Curmally', location: { center: [72.8318, 18.9272] } },
                    { id: 'wayside', category: 'Ghost Site', title: 'Wayside Inn', image: './images/wayside.jpg', description: 'Now the Khyber restaurant. Famous quaint tea room.', year: 'Early 20th C.', architect: 'N/A', builder: 'Historic Site', location: { center: [72.8317, 18.9286] } }
                ]
            };

            function parseYear(yearStr) {
                if (!yearStr) return 2025; 
                yearStr = yearStr.toString().toLowerCase();
                var match = yearStr.match(/(\d{4})/);
                if (match) return parseInt(match[0]);
                if (yearStr.includes('late 19th')) return 1890;
                if (yearStr.includes('mid 19th')) return 1850;
                if (yearStr.includes('early 19th')) return 1810;
                if (yearStr.includes('19th century')) return 1850;
                if (yearStr.includes('early 20th')) return 1910;
                if (yearStr.includes('mid 20th')) return 1950;
                if (yearStr.includes('late 20th')) return 1990;
                if (yearStr.includes('20th century')) return 1950;
                return 2025; 
            }

            // --- STATE MANAGEMENT ---
            var disabledCategories = [];
            var currentSliderYear = 2025;

            var layersContent = document.getElementById('layers-content');
            var categories = [...new Set(config.chapters.map(function(item) { return item.category; }))];
            
            // "ALL LAYERS" (Reset) Button
            var allBtn = document.createElement('div');
            allBtn.className = 'filter-btn all-layers-btn active';
            allBtn.innerHTML = 'Reset Visibility';
            allBtn.onclick = function() { resetFilters(); };
            layersContent.appendChild(allBtn);

            // CATEGORY BUTTONS (Eye Toggle Logic + SOLO Logic)
            categories.forEach(function(cat) {
                var btn = document.createElement('div'); 
                btn.className = 'filter-btn'; 
                btn.setAttribute('data-cat', cat);
                var color = config.colors[cat] || '#333';
                
                // Construct HTML with Label Group and Solo Button
                btn.innerHTML = `
                    <div class="layer-label-group">
                        <i class="fa-regular fa-eye layer-eye"></i> 
                        <span class="dot-indicator" style="color:${color}"></span> 
                        ${cat}
                    </div>
                    <span class="layer-solo-btn" title="Show Only This Layer">ONLY</span>
                `;
                
                // 1. Toggle Click
                btn.addEventListener('click', function(e) { 
                    if(e.target.classList.contains('layer-solo-btn')) return;
                    toggleCategory(cat, btn); 
                });

                // 2. Solo Click
                var soloBtn = btn.querySelector('.layer-solo-btn');
                soloBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    soloCategory(cat);
                });

                layersContent.appendChild(btn);
            });

            // --- MOBILE UI: Add Filter Toggle Button ---
            // This button sits next to the search bar on mobile
            var mobileFilterBtn = document.createElement('div');
            mobileFilterBtn.id = 'mobile-filter-toggle';
            mobileFilterBtn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
            mobileFilterBtn.style.display = 'none'; // Hidden by default (CSS handles flex display on mobile)
            
            // Insert it into the search container
            document.getElementById('search-container').appendChild(mobileFilterBtn);

            // Toggle the Console (Layers) Drawer
            mobileFilterBtn.onclick = function() {
                var consolePanel = document.getElementById('console');
                var isOpen = consolePanel.classList.contains('open');
                
                if (isOpen) {
                    consolePanel.classList.remove('open');
                    this.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                    this.style.background = '#fff';
                    this.style.color = '#333';
                } else {
                    consolePanel.classList.add('open');
                    this.innerHTML = '<i class="fa-solid fa-xmark"></i>'; // Change icon to X
                    this.style.background = '#333';
                    this.style.color = '#fff';
                    
                    // Close Details Panel if open to avoid overlap
                    closePanel(true);
                }
            };

            function toggleCategory(cat, btn) {
                if (document.body.classList.contains('mode-1883')) return;

                var icon = btn.querySelector('.layer-eye');

                // Toggle logic
                if (disabledCategories.includes(cat)) {
                    // Turn ON (Remove from disabled)
                    disabledCategories = disabledCategories.filter(c => c !== cat);
                    btn.classList.remove('layer-hidden');
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                } else {
                    // Turn OFF (Add to disabled)
                    disabledCategories.push(cat);
                    btn.classList.add('layer-hidden');
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                }
                updateMapState();
            }

            // SOLO MODE Logic
            function soloCategory(targetCat) {
                if (document.body.classList.contains('mode-1883')) return;

                // 1. Set disabled list to everything except target
                disabledCategories = categories.filter(c => c !== targetCat);

                // 2. Update all UI buttons
                var allBtns = document.querySelectorAll('.filter-btn[data-cat]');
                allBtns.forEach(b => {
                    var cat = b.getAttribute('data-cat');
                    var icon = b.querySelector('.layer-eye');

                    if (cat === targetCat) {
                        // Make Visible
                        b.classList.remove('layer-hidden');
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    } else {
                        // Make Hidden
                        b.classList.add('layer-hidden');
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    }
                });

                updateMapState();
            }

            function resetFilters() {
                if (document.body.classList.contains('mode-1883')) return;
                disabledCategories = [];
                var btns = document.querySelectorAll('.filter-btn:not(.all-layers-btn)');
                btns.forEach(b => {
                    b.classList.remove('layer-hidden');
                    var icon = b.querySelector('.layer-eye');
                    if(icon) {
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
                updateMapState();
            }

            function updateMapState() {
                markerObjects.forEach(function(m) {
                    var categoryVisible = !disabledCategories.includes(m.category);
                    var timeVisible = m.year <= currentSliderYear;

                    if (categoryVisible && timeVisible) {
                        m.element.style.display = 'flex';
                        m.element.style.opacity = '1';
                    } else {
                        m.element.style.display = 'none';
                    }
                });
                if (selectedMarker && selectedMarker.style.display === 'none') {
                    closePanel(false);
                }
            }

            var separator = document.createElement('div');
            separator.className = 'console-separator';
            layersContent.appendChild(separator);

            // --- Time Travel Button ---
            var timeBtn = document.createElement('div'); // Div for consistency
            timeBtn.id = 'time-travel-btn';
            timeBtn.className = 'filter-btn';
            timeBtn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-clock-rotate-left"></i> Time Travel</div>';
            timeBtn.onclick = function() { toggleTimeTravel(this); };
            layersContent.appendChild(timeBtn);

            // --- Time Slider Container ---
            var timeControls = document.createElement('div');
            timeControls.id = 'time-controls';
            
            var parsedYears = config.chapters.map(c => parseYear(c.year)).filter(y => !isNaN(y) && y !== 2025);
            var minYear = parsedYears.length > 0 ? Math.min(...parsedYears) : 1850;
            var maxYear = 2025;

            timeControls.innerHTML = `
                <div id="year-display">Present Day</div>
                <input type="range" id="year-slider" min="${minYear}" max="${maxYear}" value="${maxYear}" step="1">
                <div class="range-labels">
                    <span>${minYear}</span>
                    <span>Present</span>
                </div>
            `;
            layersContent.appendChild(timeControls);

            var wallBtn = document.createElement('div');
            wallBtn.id = 'wall-btn';
            wallBtn.className = 'filter-btn';
            wallBtn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-archway"></i> Toggle 1860 Fort Wall</div>';
            wallBtn.onclick = function() { toggleLayer('fort-wall-layer', this); };
            layersContent.appendChild(wallBtn);

            var map1883Btn = document.createElement('div');
            map1883Btn.id = 'btn-1883';
            map1883Btn.className = 'filter-btn';
            map1883Btn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-map-location-dot"></i> View 1883 Map</div>';
            map1883Btn.onclick = function() { toggle1883Map(this); };
            layersContent.appendChild(map1883Btn);

            var wallInfo = document.createElement('div');
            wallInfo.id = 'wall-info';
            wallInfo.innerHTML = '<strong>The Invisible Ramparts</strong>This dashed line traces the demolished fortifications of the Bombay Fort (removed 1862).';
            layersContent.appendChild(wallInfo);

            var layersHeader = document.getElementById('layers-header');
            var layersArrow = document.getElementById('layers-arrow');
            
            layersHeader.addEventListener('click', function() {
                if (layersContent.classList.contains('collapsed')) {
                    layersContent.classList.remove('collapsed');
                    layersArrow.classList.add('rotated'); 
                } else {
                    layersContent.classList.add('collapsed');
                    layersArrow.classList.remove('rotated'); 
                }
            });

            var map = new maplibregl.Map({
                container: 'map',
                style: config.style,
                center: [72.8320, 18.9275], 
                zoom: initialZoom,
                minZoom: 14.5, 
                maxBounds: [[72.8100, 18.9100], [72.8500, 18.9450]],
                pitch: 45, bearing: -15, antialias: true, attributionControl: false
            });
            
            map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
            map.addControl(new maplibregl.ScaleControl({ maxWidth: 100, unit: 'metric' }), 'bottom-left');

            document.getElementById('zoom-in-btn').addEventListener('click', function() { map.zoomIn(); });
            document.getElementById('zoom-out-btn').addEventListener('click', function() { map.zoomOut(); });
            document.getElementById('compass-btn').addEventListener('click', function() { map.flyTo({ bearing: 0, pitch: 0 }); });
            
            var is3D = true;
            var view3dBtn = document.getElementById('view-3d-btn');
            view3dBtn.classList.add('active-3d'); 
            view3dBtn.addEventListener('click', function() {
                if (is3D) { map.easeTo({ pitch: 0, bearing: 0 }); view3dBtn.classList.remove('active-3d'); is3D = false; } 
                else { map.easeTo({ pitch: 45, bearing: -15 }); view3dBtn.classList.add('active-3d'); is3D = true; }
            });
            document.getElementById('reset-view-btn').addEventListener('click', function() { map.flyTo({ center: [72.8320, 18.9275], zoom: initialZoom, pitch: 45, bearing: -15, duration: 2000 }); is3D = true; view3dBtn.classList.add('active-3d'); closePanel(true); });
            var geolocate = new maplibregl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true });
            map.addControl(geolocate); 
            document.getElementById('locate-btn').addEventListener('click', function() { geolocate.trigger(); });

            window.mapInstance = map;
            var markerObjects = [];
            var selectedMarker = null;
            var tooltip = document.getElementById('tooltip');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', function(e) {
                const val = e.target.value.toLowerCase();
                if (val.length < 1) { searchResults.style.display = 'none'; return; }
                const matches = config.chapters.filter(item => item.title.toLowerCase().includes(val) || item.category.toLowerCase().includes(val));
                if (matches.length > 0) {
                    searchResults.innerHTML = ''; searchResults.style.display = 'block';
                    matches.forEach(item => {
                        const div = document.createElement('div'); div.className = 'search-item';
                        div.innerHTML = `<span class="search-item-title">${item.title}</span><span class="search-item-cat">${item.category}</span>`;
                        div.addEventListener('click', () => { const targetObj = markerObjects.find(obj => obj.id === item.id); if (targetObj) { targetObj.element.click(); searchInput.value = ''; searchResults.style.display = 'none'; } });
                        searchResults.appendChild(div);
                    });
                } else { searchResults.style.display = 'none'; }
            });
            document.addEventListener('click', function(e) { if (!document.getElementById('search-container').contains(e.target)) { searchResults.style.display = 'none'; } });

            map.on("load", function () {
                map.setSky({ 'sky-color': '#87CEEB', 'sky-horizon-blend': 0.5, 'horizon-color': '#ffffff', 'fog-color': '#888888', 'fog-ground-blend': 0.5 });
                
                var layers = map.getStyle().layers;
                layers.forEach(function(layer) {
                    if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                        map.setLayoutProperty(layer.id, 'text-font', ['Noto Serif Regular', 'Open Sans Regular', 'Arial Unicode MS Regular']);
                    }
                });

                map.addSource('source-1883', {
                    'type': 'image',
                    'url': './images/fort-1883.jpg',
                    'coordinates': [[72.8228, 18.9435], [72.8492, 18.9435], [72.8492, 18.9235], [72.8228, 18.9235]]
                });
                map.addLayer({ 'id': 'layer-1883', 'type': 'raster', 'source': 'source-1883', 'paint': { 'raster-fade-duration': 0 }, 'layout': { 'visibility': 'none' } });

                map.addLayer({ 'id': '3d-buildings', 'source': 'openmaptiles', 'source-layer': 'building', 'type': 'fill-extrusion', 'minzoom': 15, 'paint': { 'fill-extrusion-color': '#f0f0f0', 'fill-extrusion-height': ['get', 'render_height'], 'fill-extrusion-base': ['get', 'render_min_height'], 'fill-extrusion-opacity': 0.9 } });

                var fortWallGeoJSON = { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[72.8312, 18.9278], [72.8318, 18.9276], [72.8325, 18.9273], [72.8335, 18.9268], [72.8342, 18.9265]] } };
                map.addSource('fort-wall', { 'type': 'geojson', 'data': fortWallGeoJSON });
                map.addLayer({ 'id': 'fort-wall-layer', 'type': 'line', 'source': 'fort-wall', 'layout': { 'line-join': 'round', 'line-cap': 'round', 'visibility': 'none' }, 'paint': { 'line-color': '#c0392b', 'line-width': 4, 'line-dasharray': [2, 4] } });

                config.chapters.forEach(function(record) {
                    var color = config.colors[record.category] || '#333';
                    var iconClass = config.icons[record.category] || 'fa-map-marker-alt';
                    var el = document.createElement('div'); el.className = 'marker'; el.style.backgroundColor = color; el.innerHTML = '<i class="fa-solid ' + iconClass + '"></i>';
                    
                    record.parsedYear = parseYear(record.year);

                    el.onclick = function(e) { 
                        e.stopPropagation(); 
                        openPanel(record, color, el); 
                    };
                    if (window.matchMedia('(hover: hover)').matches) {
                        el.addEventListener('mouseenter', function(e) { tooltip.innerText = record.title; var rect = el.getBoundingClientRect(); tooltip.style.left = rect.left + (rect.width / 2) + 'px'; tooltip.style.top = rect.top + 'px'; tooltip.style.opacity = '1'; });
                        el.addEventListener('mouseleave', function() { tooltip.style.opacity = '0'; });
                    }
                    var marker = new maplibregl.Marker({ element: el, anchor: 'bottom' }).setLngLat(record.location.center).addTo(map);
                    markerObjects.push({ element: el, category: record.category, marker: marker, id: record.id, title: record.title, year: record.parsedYear });
                });
            });

            document.getElementById('close-btn').addEventListener('click', function() { closePanel(false); });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape") closePanel(false); });
            
            // Map click closes panels AND Mobile Drawer
            map.on('click', function() { 
                closePanel(false); 
                document.getElementById('console').classList.remove('open');
                // Reset mobile button
                var btn = document.getElementById('mobile-filter-toggle');
                if(btn) {
                    btn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                    btn.style.background = '#fff';
                    btn.style.color = '#333';
                }
            });

            // --- Time Slider Logic ---
            var isTimeTravelActive = false;
            
            window.toggleTimeTravel = function(btn) {
                var controls = document.getElementById('time-controls');
                var slider = document.getElementById('year-slider');
                var allLayerBtns = document.querySelectorAll('#layers-content .filter-btn:not(#time-travel-btn):not(#wall-btn):not(#btn-1883)');

                if (isTimeTravelActive) {
                    isTimeTravelActive = false;
                    btn.classList.remove('active');
                    controls.classList.remove('active');
                    currentSliderYear = 2025; // Reset Time
                    updateMapState();
                } else {
                    isTimeTravelActive = true;
                    btn.classList.add('active');
                    controls.classList.add('active');
                    slider.dispatchEvent(new Event('input'));
                    
                    // Auto scroll to reveal
                    setTimeout(() => {
                        var container = (window.innerWidth <= 768) ? document.getElementById('console') : document.getElementById('header');
                        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                    }, 100);
                }
            };

            document.addEventListener('input', function(e) {
                if (e.target.id === 'year-slider') {
                    var year = parseInt(e.target.value);
                    var max = parseInt(e.target.max);
                    var display = document.getElementById('year-display');
                    
                    if (year === max) display.innerText = "Present Day";
                    else display.innerText = "Year: " + year;

                    currentSliderYear = year;
                    updateMapState();
                }
            });

            function openPanel(record, color, markerEl) {
                if (selectedMarker) selectedMarker.classList.remove('selected');
                markerEl.classList.add('selected');
                selectedMarker = markerEl;

                var infoHTML = '<div class="panel-info">' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Year</span><span class="panel-info-val">' + record.year + '</span></div>' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Architect</span><span class="panel-info-val">' + record.architect + '</span></div>' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Builder</span><span class="panel-info-val">' + record.builder + '</span></div>' + 
                '</div>';

                var destLat = record.location.center[1]; var destLng = record.location.center[0];
                var navUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
                var navButton = `<a href="${navUrl}" target="_blank" class="panel-action-btn"><i class="fa-solid fa-diamond-turn-right"></i> Navigate Here</a>`;

                // STATIC IMAGE
                var imageHTML = `<div class="panel-img-container"><img src="${record.image}" class="panel-img"></div>`;

                var panelContent = imageHTML + 
                    '<div class="panel-content">' + 
                    '<span class="panel-cat" style="color:' + color + '">' + record.category + '</span>' + 
                    '<div class="panel-title">' + record.title + '</div>' + 
                    '<p class="panel-desc">' + record.description + '</p>' + 
                    infoHTML + navButton + 
                    '</div>';

                document.getElementById('panel-inner').innerHTML = panelContent; 
                document.getElementById('side-panel').classList.add('open');
                
                // If opening panel on mobile, ensure filter drawer is closed
                if(window.innerWidth <= 768) {
                    document.getElementById('console').classList.remove('open');
                    var filterBtn = document.getElementById('mobile-filter-toggle');
                    if(filterBtn) {
                        filterBtn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                        filterBtn.style.background = '#fff';
                        filterBtn.style.color = '#333';
                    }
                }

                if (window.innerWidth >= 768) {
                    map.flyTo({ center: record.location.center, zoom: 17.5, pitch: map.getPitch(), bearing: map.getBearing(), speed: 0.8, curve: 1 });
                }
            }

            function closePanel(preventCameraMove) {
                document.getElementById('side-panel').classList.remove('open');
                if (selectedMarker) { selectedMarker.classList.remove('selected'); selectedMarker = null; }
                if (!preventCameraMove && window.innerWidth >= 768) { map.flyTo({ zoom: initialZoom, speed: 0.6 }); }
            }

            window.toggleLayer = function(layerId, btn) {
                if (document.body.classList.contains('mode-1883')) return;
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var infoBox = document.getElementById('wall-info');
                if (visibility === 'visible') { map.setLayoutProperty(layerId, 'visibility', 'none'); btn.classList.remove('active'); infoBox.style.display = 'none'; } 
                else { map.setLayoutProperty(layerId, 'visibility', 'visible'); btn.classList.add('active'); infoBox.style.display = 'block'; }
            };

            window.toggle1883Map = function(btn) {
                var layerId = 'layer-1883';
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var body = document.body;
                
                if (visibility === 'visible') {
                    // Turn OFF 1883 Map
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                    btn.classList.remove('active');
                    btn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-map-location-dot"></i> View 1883 Map</div>';
                    body.classList.remove('mode-1883');
                    
                    // Reset all
                    updateMapState();
                } else {
                    // Turn ON 1883 Map
                    
                    // FORCE CLOSE Time Travel if active
                    if (isTimeTravelActive) {
                        var timeBtn = document.getElementById('time-travel-btn');
                        toggleTimeTravel(timeBtn); 
                    }

                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                    btn.classList.add('active');
                    btn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-times"></i> Exit 1883 Map</div>';
                    body.classList.add('mode-1883');
                    
                    // Hide all markers
                    markerObjects.forEach(function(m) { m.element.style.display = 'none'; });
                    
                    closePanel(true);
                    map.flyTo({ center: [72.8360, 18.9335], zoom: 14.5, pitch: 0, bearing: 0 });
                }
            };
        }
    </script>
</body>
</html>