<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visual Audit: Kala Ghoda</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* --- VINTAGE THEME VARIABLES --- */
        :root {
            --paper-bg: #f4f1ea; 
            --paper-border: #888;
            --text-dark: #222; 
            --text-light: #555;
            --accent: #8c2f00; 
            --shadow: 0 10px 30px rgba(0,0,0,0.08); 
        }
        
        body { margin: 0; padding: 0; font-family: 'Lato', sans-serif; overflow: hidden; background: #eee; }
        
        #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        /* THE VINTAGE FILTER (Applied to canvas only) */
        .maplibregl-canvas-container canvas {
            filter: sepia(0.25) contrast(0.95) saturate(0.4);
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-dark); border-radius: 0; }

        /* --- UI: HEADER --- */
        #header {
            position: absolute; top: 30px; left: 30px; width: 340px;
            background: var(--paper-bg);
            border: 1px solid var(--paper-border);
            z-index: 100;
            box-shadow: var(--shadow);
        }
        #header::before { 
            content: ''; position: absolute; top: 4px; left: 4px; right: 4px; height: 100%; 
            border: 1px solid rgba(0,0,0,0.1); pointer-events: none; 
        }

        #header h1 { 
            font-family: 'Cardo', serif; 
            font-size: 28px; font-weight: 700; 
            text-transform: uppercase; padding: 25px 25px 5px 25px; margin: 0; 
            color: var(--text-dark);
            letter-spacing: 1px;
            display: inline-block;
            margin-bottom: 5px;
        }
        #header h2 { 
            font-family: 'Lato', sans-serif; font-size: 11px; color: var(--accent); 
            padding: 0 25px 20px 25px; margin: 0; text-transform: uppercase; letter-spacing: 2px; 
            font-weight: 700; border-bottom: 2px solid var(--text-dark);
        }

        /* --- UI: FILTERS --- */
        #console { padding: 20px 25px 25px 25px; display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-btn {
            padding: 6px 12px;
            font-size: 10px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px;
            border: 1px solid var(--paper-border); 
            background: #fff; 
            color: var(--text-light); cursor: pointer; 
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 6px;
            font-family: 'Lato', sans-serif;
        }
        .filter-btn:hover { background: var(--text-dark); border-color: var(--text-dark); color: #fff; }
        .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .dot-indicator { width: 6px; height: 6px; border-radius: 50%; display: inline-block; background: currentColor; }

        /* --- UI: MARKERS & TOOLTIP --- */
        .marker {
            width: 32px; height: 32px;
            border-radius: 50%;
            /* Background color set by JS */
            border: 2px solid #fff; 
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #fff; 
            transition: transform 0.2s ease;
            z-index: 10;
        }
        .marker:hover { transform: scale(1.1); z-index: 20; }
        .marker.selected { 
            transform: scale(1.3); z-index: 30;
            box-shadow: 0 0 0 3px #fff; 
        }

        /* CUSTOM TOOLTIP */
        #tooltip {
            position: absolute; 
            pointer-events: none;
            background: #fff; color: var(--text-dark);
            padding: 5px 10px; font-size: 11px; font-family: 'Lato', sans-serif; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            border: 1px solid var(--text-dark);
            opacity: 0;
            transform: translate(-50%, -150%);
            transition: opacity 0.2s; z-index: 500;
            white-space: nowrap;
        }
        
        /* --- UI: SIDE PANEL --- */
        #side-panel {
            position: fixed; right: -450px; top: 0; bottom: 0; width: 400px;
            background: var(--paper-bg);
            z-index: 200;
            box-shadow: -1px 0 0 rgba(0,0,0,0.2); 
            transition: right 0.5s cubic-bezier(0.77, 0, 0.175, 1);
            overflow-y: auto; 
        }
        #side-panel.open { right: 0; }
        
        .panel-img-container { 
            position: relative; width: 100%; height: 300px; overflow: hidden; 
        }
        .panel-img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(20%) sepia(10%); }
        
        .panel-content { padding: 40px; }
        .panel-cat {
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
            padding-bottom: 5px; color: var(--accent); margin-bottom: 15px; display: block;
            font-weight: 700; border-bottom: 1px solid #ccc; display: inline-block;
        }
        .panel-title {
            font-family: 'Cardo', serif; 
            font-size: 36px; font-weight: 400; 
            margin-bottom: 20px; color: var(--text-dark); line-height: 1;
        }
        .panel-desc { 
            font-size: 17px; color: #444; line-height: 1.8; margin-bottom: 30px; 
            font-family: 'Cardo', serif; 
        }
        
        .panel-info {
            background: #fff; padding: 25px; 
            border: 1px solid var(--paper-border);
        }
        .panel-info-row { margin-bottom: 12px; font-size: 14px; color: var(--text-dark); display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .panel-info-row:last-child { border-bottom: none; }
        .panel-info-row strong { font-family: 'Lato', sans-serif; text-transform: uppercase; font-size: 10px; letter-spacing: 1px; color: #888; }

        .panel-close {
            position: absolute; top: 20px; right: 20px; width: 40px; height: 40px;
            background: #fff; color: var(--text-dark); border: 1px solid #ccc;
            cursor: pointer; font-size: 24px; z-index: 5;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .panel-close:hover { background: var(--text-dark); color: #fff; }

        /* RESET BUTTON */
        #reset-btn {
            position: fixed; 
            top: 20px; 
            right: 120px; 
            background: var(--paper-bg); color: var(--text-dark); border: 1px solid var(--paper-border);
            padding: 10px 15px; 
            font-family: 'Lato', sans-serif; font-weight: bold; font-size: 11px; letter-spacing: 1px;
            cursor: pointer; 
            z-index: 90; transition: all 0.2s;
            display: flex; align-items: center; gap: 8px;
            text-transform: uppercase;
        }
        #reset-btn:hover { background: var(--text-dark); color: #fff; border-color: var(--text-dark); }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 768px) {
            #header { top: 15px; left: 15px; right: 15px; width: auto; max-width: none; }
            #side-panel { right: auto; left: 0; bottom: -100vh; top: auto; width: 100%; height: 75vh; border-left: none; border-top: 5px solid var(--text-dark); }
            #side-panel.open { bottom: 0; }
            #reset-btn { top: auto; bottom: 30px; right: 20px; } 
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="tooltip"></div> 
    
    <div id="header">
        <div id="console"></div>
    </div>

    <button id="reset-btn"><i class="fa-solid fa-compress"></i> Reset View</button>

    <div id="side-panel">
        <button class="panel-close" id="close-btn">×</button>
        <div id="panel-inner"></div>
    </div>

    <script>
        window.addEventListener('load', function() {
            initMap();
        });

        function initMap() {
            var config = {
                style: 'https://api.maptiler.com/maps/019b6fe6-78c4-7dcb-b6eb-fed1b18171df/style.json?key=f0f0aibL2C05fTzSrqHq', 
                title: 'Visual Audit: Kala Ghoda',
                subtitle: 'Architectural Heritage Survey',
                
                colors: {
                    'Art Deco': '#2a9d8f',
                    'Victorian': '#e76f51',
                    'Texture': '#e9c46a',
                    'Modern': '#264653',
                    'Lettering': '#6a4c93'
                },
                
                icons: {
                    'Art Deco': 'fa-building',
                    'Victorian': 'fa-landmark',
                    'Texture': 'fa-eye',
                    'Modern': 'fa-square',
                    'Lettering': 'fa-font'
                },

                chapters: [
                    {
                        id: 'regal',
                        category: 'Art Deco',
                        title: 'Regal Cinema',
                        image: './images/regal.jpg',
                        description: 'One of the earliest Art Deco cinemas in India, characterised by ziggurat style stepping and strong vertical emphasis.',
                        year: '1933',
                        architect: 'Charles Stevens',
                        builder: 'Framji Sidhwa',
                        location: { center: [72.8334, 18.9279] } // Clean coords
                    },
                    {
                        id: 'museum',
                        category: 'Victorian',
                        title: 'CSMVS Museum',
                        image: './images/csmvs.jpg',
                        description: 'Indo Saracenic landmark constructed using grey Kurla basalt and yellow Malad stone.',
                        year: '1914',
                        architect: 'George Wittet',
                        builder: 'Govt. of Bombay',
                        location: { center: [72.8327, 18.9269] }
                    },
                    {
                        id: 'elphinstone',
                        category: 'Victorian',
                        title: 'Elphinstone College',
                        image: './images/elphinstone.jpg',
                        description: 'Victorian Gothic Revival building with pointed arches, stone detailing, and ornamental gargoyles.',
                        year: '1871',
                        architect: 'James Trubshawe',
                        builder: 'Unknown',
                        location: { center: [72.8313, 18.9265] }
                    },
                    {
                        id: 'sassoon',
                        category: 'Victorian',
                        title: 'David Sassoon Library',
                        image: './images/sassoon.jpg',
                        description: 'Victorian Gothic architecture defined by pointed arches, lancet windows, and symmetrical massing.',
                        year: '1870',
                        architect: 'Campbell & Gosling',
                        builder: 'Scott McClelland',
                        location: { center: [72.8316, 18.9272] }
                    },
                    {
                        id: 'army',
                        category: 'Victorian',
                        title: 'Army and Navy Building',
                        image: './images/army-navy.jpg',
                        description: 'Late nineteenth century Neo Classical commercial building retaining original serif signage.',
                        year: 'Late 19th C.',
                        architect: 'Unknown',
                        builder: 'British Military',
                        location: { center: [72.8322, 18.9285] }
                    },
                    {
                        id: 'esplanade',
                        category: 'Texture',
                        title: 'Esplanade Mansion',
                        image: './images/esplanade.jpg',
                        description: 'One of the earliest cast iron framed buildings in Mumbai, with exposed iron elements.',
                        year: '1865',
                        architect: 'Unknown',
                        builder: 'British Engineers',
                        location: { center: [72.8311, 18.9282] }
                    },
                    {
                        id: 'jehangir',
                        category: 'Modern',
                        title: 'Jehangir Art Gallery',
                        image: './images/jehangir.jpg',
                        description: 'Modernist concrete structure with a distinctive cantilevered entrance.',
                        year: '1952',
                        architect: 'G. M. Bhuta',
                        builder: 'Sir Cowasji Jehangir',
                        location: { center: [72.8317, 18.9275] }
                    },
                    {
                        id: 'statue',
                        category: 'Texture',
                        title: 'Kala Ghoda Statue',
                        image: './images/placeholder.jpg',
                        description: 'Bronze statue installed to mark the historic site of the original Black Horse.',
                        year: '2017',
                        architect: 'Commissioned Art',
                        builder: 'KG Association',
                        location: { center: [72.8318, 18.9277] }
                    },
                    {
                        id: 'synagogue',
                        category: 'Victorian',
                        title: 'Keneseth Eliyahoo',
                        image: './images/synagogue.jpg',
                        description: 'Victorian era synagogue built for the Baghdadi Jewish community, noted for its blue façade.',
                        year: '1884',
                        architect: 'Unknown',
                        builder: 'Jewish Community',
                        location: { center: [72.8324, 18.9278] }
                    },
                    {
                        id: 'ropewalk',
                        category: 'Texture',
                        title: 'Rope Walk Lane',
                        image: './images/ropewalk.jpg',
                        description: 'Historic lane characterised by enamel street signage and layered brickwork.',
                        year: '19th Century',
                        architect: 'Incremental',
                        builder: 'Multiple',
                        location: { center: [72.8320, 18.9270] }
                    },
                    {
                        id: 'army-lettering',
                        category: 'Lettering',
                        title: 'Army/Navy Signage',
                        image: './images/army-lettering.jpg',
                        description: 'Original carved and painted serif lettering integrated into the building façade.',
                        year: 'Late 19th C.',
                        architect: 'Unknown',
                        builder: 'British Military',
                        location: { center: [72.83225, 18.92855] }
                    },
                    {
                        id: 'ropewalk-signs',
                        category: 'Lettering',
                        title: 'Street Signs',
                        image: './images/ropewalk-lettering.jpg',
                        description: 'Blue enamel street signage with bilingual lettering.',
                        year: '20th Century',
                        architect: 'Municipal',
                        builder: 'BMC',
                        location: { center: [72.83205, 18.92705] }
                    }
                ]
            };

            // Setup Header
            var titleHTML = '<h1>' + config.title + '</h1><h2>' + config.subtitle + '</h2>';
            document.getElementById('console').insertAdjacentHTML('beforebegin', titleHTML);

            var consoleDiv = document.getElementById('console');
            var categories = [...new Set(config.chapters.map(function(item) { return item.category; }))];
            
            // Filters
            var allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.innerHTML = 'All Layers';
            allBtn.onclick = function() { filterMarkers('all', this); };
            consoleDiv.appendChild(allBtn);

            categories.forEach(function(cat) {
                var btn = document.createElement('button');
                btn.className = 'filter-btn';
                var color = config.colors[cat] || '#333';
                btn.innerHTML = '<span class="dot-indicator" style="color:' + color + '"></span> ' + cat;
                btn.onclick = function() { filterMarkers(cat, this); };
                consoleDiv.appendChild(btn);
            });

            // Init Map (Reduced pitch)
            var map = new maplibregl.Map({
                container: 'map',
                style: config.style,
                center: [72.8325, 18.9275],
                zoom: 16.5,
                pitch: 30, // Lower initial pitch
                bearing: -15,
                antialias: true 
            });
            map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }));
            window.mapInstance = map;

            var markerObjects = [];
            var selectedMarker = null;
            var tooltip = document.getElementById('tooltip');

            map.on("load", function () {
                // Add 3D buildings layer
                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'openmaptiles', 
                    'source-layer': 'building',
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#d0d0d0', 
                        'fill-extrusion-height': ['get', 'render_height'],
                        'fill-extrusion-base': ['get', 'render_min_height'],
                        'fill-extrusion-opacity': 0.7
                    }
                });

                config.chapters.forEach(function(record) {
                    var color = config.colors[record.category] || '#333';
                    var iconClass = config.icons[record.category] || 'fa-map-marker-alt';

                    var el = document.createElement('div');
                    el.className = 'marker';
                    el.style.backgroundColor = color; 
                    el.innerHTML = '<i class="fa-solid ' + iconClass + '"></i>';

                    // CLICK Event
                    el.onclick = function(e) {
                        e.stopPropagation();
                        openPanel(record, color, el);
                    };

                    // HOVER Event (Tooltip)
                    el.addEventListener('mouseenter', function(e) {
                        tooltip.innerText = record.title;
                        var rect = el.getBoundingClientRect();
                        tooltip.style.left = rect.left + (rect.width / 2) + 'px';
                        tooltip.style.top = rect.top + 'px';
                        tooltip.style.opacity = '1';
                    });

                    el.addEventListener('mouseleave', function() {
                        tooltip.style.opacity = '0';
                    });

                    var marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
                        .setLngLat(record.location.center)
                        .addTo(map);

                    markerObjects.push({ element: el, category: record.category, marker: marker });
                });
            });

            // --- LISTENERS ---
            document.getElementById('close-btn').addEventListener('click', function() { closePanel(false); });
            document.getElementById('reset-btn').addEventListener('click', function() {
                // RESET: Gentle movement, no rotation
                map.flyTo({ center: [72.8325, 18.9275], zoom: 16.5, pitch: 30, bearing: -15, duration: 2000 });
                closePanel(true);
            });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape") closePanel(false); });
            map.on('click', function() { closePanel(false); });

            // --- PANEL LOGIC ---
            function openPanel(record, color, markerEl) {
                if (selectedMarker) selectedMarker.classList.remove('selected');
                markerEl.classList.add('selected');
                selectedMarker = markerEl;

                var infoHTML = '<div class="panel-info">' +
                    '<div class="panel-info-row"><strong>Year</strong> ' + record.year + '</div>' +
                    '<div class="panel-info-row"><strong>Architect</strong> ' + record.architect + '</div>' +
                    '<div class="panel-info-row"><strong>Builder</strong> ' + record.builder + '</div>' +
                    '</div>';

                var panelContent = '<div class="panel-img-container"><img src="' + record.image + '" class="panel-img"></div>' +
                    '<div class="panel-content">' +
                    '<span class="panel-cat" style="color:' + color + '">' + record.category + '</span>' +
                    '<div class="panel-title">' + record.title + '</div>' +
                    '<p class="panel-desc">' + record.description + '</p>' +
                    infoHTML +
                    '</div>';

                document.getElementById('panel-inner').innerHTML = panelContent;
                document.getElementById('side-panel').classList.add('open');

                // --- THE COMFORT MODE FIX ---
                // We keep the current pitch and bearing (no rotation/tilting)
                // We only pan to the location and adjust zoom slightly
                map.flyTo({
                    center: record.location.center,
                    zoom: 17.5, // Standard consistent zoom
                    pitch: map.getPitch(), // Keep current pitch
                    bearing: map.getBearing(), // Keep current rotation
                    speed: 0.8, // Slower speed
                    curve: 1.2
                });
            }

            function closePanel(preventCameraMove) {
                document.getElementById('side-panel').classList.remove('open');
                
                if (selectedMarker) {
                    selectedMarker.classList.remove('selected');
                    selectedMarker = null;
                }
                
                if (!preventCameraMove) {
                    // Gentle zoom out, no rotation
                    map.flyTo({ zoom: map.getZoom() - 0.5, speed: 0.6 });
                }
            }

            function filterMarkers(selectedCat, clickedBtn) {
                var buttons = document.getElementsByClassName('filter-btn');
                for (var i = 0; i < buttons.length; i++) buttons[i].classList.remove('active');
                clickedBtn.classList.add('active');

                markerObjects.forEach(function(m) {
                    if (selectedCat === 'all' || m.category === selectedCat) {
                        m.element.style.display = 'flex';
                        m.element.style.opacity = '1';
                    } else {
                        m.element.style.display = 'none';
                    }
                });

                if (selectedMarker && selectedMarker.style.display === 'none') closePanel(false);
            }
        }
    </script>
</body>
</html>