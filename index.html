<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visual Audit: Kala Ghoda Heritage</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover' />
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* --- THEME & VARIABLES --- */
        :root {
            --bg: #ffffff;
            --text-main: #222;
            --text-sub: #555;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
            --accent-wall: #c0392b; 
            --accent-nav: #2980b9; 
            --gold-text: #cfa842; 
            --gold-thumb: #d4af37;
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }
        
        body { margin: 0; padding: 0; font-family: 'Lato', sans-serif; overflow: hidden; background: #f4f4f4; -webkit-tap-highlight-color: transparent; }
        
        #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        .maplibregl-canvas-container canvas { filter: sepia(0.1) contrast(0.95); transition: filter 0.5s ease; }
        
        /* --- 1883 MODE STYLING --- */
        body.mode-1883 #map canvas { filter: grayscale(1) contrast(0.9) brightness(1.1) !important; }
        
        body.mode-1883 .filter-btn { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        body.mode-1883 #search-container { opacity: 0.4; pointer-events: none; }
        
        /* Grey out controls except 1883 button, Zoom, Compass */
        body.mode-1883 .v-control-btn:not(#map-1883-btn):not(#zoom-in-btn):not(#zoom-out-btn):not(#compass-btn) {
            opacity: 0.4; pointer-events: none; background: #eee; color: #ccc;
        }

        body.mode-1883 #map-1883-btn { background: #222; color: #fff; border-color: #222; opacity: 1 !important; }


        /* --- UI: HEADER --- */
        #header {
            position: absolute; top: 20px; left: 20px; 
            width: 340px; background: var(--bg); z-index: 100;
            box-shadow: var(--shadow); border: 1px solid var(--border); border-radius: 8px; 
            display: flex; flex-direction: column;
            max-height: 85vh; overflow-y: auto; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #header h1 { font-family: 'Cardo', serif; padding: 20px 20px 5px 20px; margin: 0; line-height: 1.2; }
        .title-sub { display: block; font-size: 13px; font-weight: 900; color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .title-main { display: block; font-size: 28px; font-weight: 400; color: var(--gold-text); margin-top: 5px; }
        #header h2 { font-family: 'Lato', sans-serif; font-size: 10px; color: #aaa; padding: 0 20px 15px 20px; margin: 0; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; border-bottom: 1px solid var(--border); }

        /* --- UI: SEARCH --- */
        #search-container { position: relative; padding: 15px 20px 5px 20px; }
        .search-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
        #search-input { width: 100%; padding: 12px 10px 12px 40px; font-family: 'Lato', sans-serif; font-size: 14px; border: 1px solid #ddd; background: #fafafa; outline: none; border-radius: 6px; transition: all 0.2s; height: 44px; box-sizing: border-box; }
        #search-input:focus { border-color: #333; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .search-icon { position: absolute; left: 14px; color: #999; font-size: 14px; pointer-events: none; }
        
        #search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid var(--border); border-top: none; max-height: 250px; overflow-y: auto; z-index: 110; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 0 0 6px 6px; }
        .search-item { padding: 14px 14px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; flex-direction: column; }
        .search-item:hover { background: #f9f9f9; }
        .search-item-title { font-weight: 700; font-size: 13px; color: #333; }
        .search-item-cat { font-size: 11px; color: #888; text-transform: uppercase; margin-top: 2px; }
        .search-empty { padding: 15px; text-align: center; color: #999; font-size: 12px; font-style: italic; }

        /* --- UI: LAYERS LIST --- */
        #console { padding: 0 20px 20px 20px; display: flex; flex-direction: column; }
        #layers-header { 
            padding: 15px 0 10px 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
            font-size: 12px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; color: #444; user-select: none;
        }
        #layers-header:hover { color: #000; }
        #layers-arrow { transition: transform 0.3s ease; }
        #layers-arrow.rotated { transform: rotate(180deg); }
        
        #layers-content { display: flex; flex-wrap: wrap; gap: 8px; overflow: hidden; transition: max-height 0.4s ease; max-height: 2000px; }
        #layers-content.collapsed { max-height: 0; margin-top: 0; }

        .filter-btn { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 6px 0 10px; 
            width: 100%; height: 40px;
            font-size: 11px; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; 
            border: 1px solid #e0e0e0; background: #fff; color: #555; border-radius: 6px; 
            transition: all 0.2s; box-sizing: border-box; flex-shrink: 0;
        }
        .filter-btn:hover { border-color: #bbb; background: #fdfdfd; }
        
        .layer-label-group { display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer; }
        .layer-actions { display: flex; align-items: center; gap: 4px; }

        .layer-solo-btn {
            font-size: 9px; background: #f0f0f0; color: #777;
            padding: 0 8px; border-radius: 4px; cursor: pointer; transition: all 0.2s;
            height: 24px; display: flex; align-items: center; justify-content: center;
            font-weight: 900; border: 1px solid transparent;
        }
        .layer-solo-btn:hover { background: #e0e0e0; color: #333; }
        
        /* Active State for Solo Button (Blue) */
        .layer-solo-btn.active-solo { background: var(--accent-nav) !important; color: #fff !important; border-color: var(--accent-nav) !important; }

        .layer-eye-btn {
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
            color: #777; cursor: pointer; border-radius: 4px; transition: all 0.2s; font-size: 14px;
        }
        .layer-eye-btn:hover { background: #eee; color: #000; }

        .filter-btn.layer-hidden { background: #f8f8f8; }
        .filter-btn.layer-hidden .layer-label-group { color: #aaa; }
        .filter-btn.layer-hidden .dot-indicator { background: #ccc !important; }
        .filter-btn.layer-hidden .layer-eye-btn { color: #ccc; }
        
        .dot-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: currentColor; }

        .filter-btn.all-layers-btn { justify-content: center; background: #222; color: #fff; cursor: pointer; }
        .filter-btn.all-layers-btn:hover { background: #444; }

        .console-separator { width: 100%; border-bottom: 1px solid #eee; margin: 10px 0; height: 1px; flex-shrink: 0; }

        /* Fort Wall Info Box (Restored) */
        #wall-info { display: none; margin-top: 8px; padding: 10px; background: #fff4f4; border-left: 3px solid var(--accent-wall); font-size: 11px; color: #555; line-height: 1.4; border-radius: 2px; width: 100%; box-sizing: border-box; }
        #wall-info strong { display: block; margin-bottom: 3px; color: var(--accent-wall); text-transform: uppercase; font-weight: 800; font-size: 10px; }

        /* --- UI: TIME SLIDER WIDGET --- */
        #time-widget {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200%);
            width: 90%; max-width: 380px;
            background: #fff; border-radius: 12px;
            padding: 25px 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 120; display: flex; flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-sizing: border-box;
        }
        #time-widget.active { transform: translateX(-50%) translateY(0); }

        .widget-close { 
            position: absolute; top: 15px; right: 15px; 
            background: transparent; color: #aaa; 
            width: 24px; height: 24px; text-align: center; line-height: 24px; 
            cursor: pointer; font-size: 20px; transition: color 0.2s;
        }
        .widget-close:hover { color: #222; }

        #year-display { 
            text-align: center; font-family: 'Cardo', serif; font-size: 26px; 
            color: var(--accent-wall); margin-bottom: 15px; font-weight: 400; 
        }
        
        .range-labels { display: flex; justify-content: space-between; font-size: 12px; color: #888; font-weight: 700; margin-top: 5px; padding: 0 4px; }

        /* Slider Styling */
        input[type=range] { 
            -webkit-appearance: none; width: 100%; background: transparent; 
            margin: 0; height: 30px; display: block; cursor: pointer;
        }
        input[type=range]:focus { outline: none; }
        
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e0e0e0; border-radius: 2px; margin-top: 13px; }
        input[type=range]::-moz-range-track { width: 100%; height: 4px; cursor: pointer; background: #e0e0e0; border-radius: 2px; }
        
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: var(--gold-thumb); cursor: pointer; margin-top: -10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid #fff; 
        }
        input[type=range]::-moz-range-thumb { 
            height: 24px; width: 24px; border-radius: 50%; 
            background: var(--gold-thumb); cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid #fff; 
        }

        /* --- UI: MARKERS --- */
        .marker { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; font-size: 14px; color: #fff; transition: transform 0.2s ease; z-index: 10; background-size: cover; }
        .marker:hover { transform: scale(1.15); z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .marker.selected { transform: scale(1.3); z-index: 30; box-shadow: 0 0 0 3px #fff, 0 8px 20px rgba(0,0,0,0.3); }
        #tooltip { position: absolute; pointer-events: none; background: #111; color: #fff; padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; border-radius: 4px; opacity: 0; z-index: 500; white-space: nowrap; transform: translate(-50%, -10px); transition: opacity 0.2s; }

        /* --- UI: SIDE PANEL --- */
        #side-panel { position: fixed; right: -450px; top: 0; bottom: 0; width: 400px; background: #fff; z-index: 200; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); display: flex; flex-direction: column; border-left: 1px solid var(--border); }
        #side-panel.open { transform: translateX(-450px); }
        #panel-scroll-area { flex: 1; overflow-y: auto; }
        .panel-img-container { width: 100%; height: 260px; background: #eee; }
        .panel-img { width: 100%; height: 100%; object-fit: cover; }
        .panel-content { padding: 25px 30px; }
        .panel-cat { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; color: #999; margin-bottom: 10px; display: inline-block; }
        .panel-title { font-family: 'Cardo', serif; font-size: 28px; margin-bottom: 15px; line-height: 1.1; color: #111; }
        .panel-desc { line-height: 1.6; color: #444; font-size: 15px; margin-bottom: 25px; }
        .panel-info { display: table; width: 100%; border-top: 1px solid #eee; padding-top: 20px; }
        .panel-info-row { display: table-row; }
        .panel-info-label { display: table-cell; padding: 8px 0; font-size: 10px; text-transform: uppercase; color: #999; letter-spacing: 1px; width: 30%; font-weight: 700; }
        .panel-info-val { display: table-cell; padding: 8px 0; font-size: 13px; color: #222; font-weight: 400; }
        .panel-close { position: absolute; top: 15px; right: 15px; width: 36px; height: 36px; background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 300; display: flex; align-items: center; justify-content: center; }
        .panel-close:hover { background: #000; }
        .panel-action-btn { display: block; width: 100%; margin-top: 20px; padding: 14px 0; text-align: center; text-decoration: none; background: var(--accent-nav); color: #fff; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border-radius: 6px; }

        /* --- UI: CONTROLS (SLIDE-OUT) --- */
        #vertical-controls { 
            position: fixed; right: 20px; bottom: 30px; 
            display: flex; flex-direction: column; gap: 8px; z-index: 95;
            align-items: flex-end; 
        }
        
        .v-control-btn { 
            width: 40px; height: 40px; border: none; background: #fff; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; 
            color: #555; font-size: 16px; cursor: pointer; 
            display: flex; align-items: center; 
            justify-content: flex-start;
            flex-direction: row-reverse;
            padding: 0; 
            transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1), background 0.2s, opacity 0.3s;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .v-control-btn i { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        
        .v-control-btn span {
            opacity: 0; padding-left: 12px; padding-right: 2px;
            font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            transform: translateX(10px); transition: all 0.2s ease;
        }
        
        .v-control-btn:hover { width: auto; padding-left: 10px; background: #111; color: #fff; }
        .v-control-btn:hover span { opacity: 1; transform: translateX(0); }
        .v-control-btn.active-control { background: #222; color: #fff; } 
        
        .maplibregl-ctrl-top-right { display: none !important; }
        .maplibregl-ctrl-scale { background-color: rgba(255, 255, 255, 0.9) !important; border: 1px solid var(--border) !important; color: #333 !important; font-family: 'Lato', sans-serif !important; font-size: 10px !important; border-radius: 2px !important; box-shadow: none !important; }

        /* --- UI: TOAST --- */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #222; color: #fff; padding: 12px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 1000; opacity: 0; transition: opacity 0.5s ease; pointer-events: none;
            display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        #toast.show { opacity: 1; pointer-events: auto; }

        /* ================= MOBILE MODE ================= */
        @media (max-width: 768px) {
            #header { top: 15px; left: 15px; right: 15px; width: auto; max-height: none; background: transparent; box-shadow: none; border: none; overflow: visible; }
            #header h1, #header h2 { display: none; }
            
            #search-container { padding: 0; background: transparent; display: flex; gap: 10px; }
            .search-wrapper { flex: 1; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; background: #fff; }
            #search-input { height: 50px; font-size: 16px; border: none; }
            .search-icon { font-size: 16px; top: 17px; }
            #search-results { left: 0; right: 0; top: 55px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
            
            #mobile-filter-toggle {
                display: flex !important; width: 50px; height: 50px; flex-shrink: 0;
                background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                align-items: center; justify-content: center; font-size: 18px; color: #333;
                cursor: pointer; transition: all 0.2s;
            }

            #console {
                position: fixed; left: 0; right: 0; bottom: 0;
                background: #fff; border-radius: 20px 20px 0 0;
                box-shadow: 0 -5px 30px rgba(0,0,0,0.15);
                padding: 20px; z-index: 150;
                transform: translateY(110%); 
                transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                max-height: 75vh; overflow-y: auto; 
                padding-bottom: calc(20px + var(--safe-area-bottom));
                display: block; 
            }
            #console.open { transform: translateY(0); }
            #console::before { content: ''; display: block; width: 40px; height: 5px; background: #ddd; margin: 0 auto 15px auto; border-radius: 3px; }

            #layers-content { max-height: none !important; opacity: 1; margin-top: 10px; display: flex; flex-direction: column; gap: 10px; overflow: visible; }
            #layers-header { display: none; }

            .filter-btn { height: 50px; font-size: 13px; margin-bottom: 0; }
            .layer-solo-btn { height: 30px; padding: 0 12px; font-size: 10px; background: #f0f0f0; border: 1px solid #ddd; }
            .layer-eye-btn { width: 40px; height: 100%; font-size: 18px; }
            
            #side-panel { right: auto; left: 0; top: auto; bottom: 0; width: 100%; height: 80vh; transform: translateY(110%); border-radius: 20px 20px 0 0; border-top: 1px solid #eee; border-left: none; }
            #side-panel.open { transform: translateY(0); }
            .panel-close { top: 20px; right: 20px; background: #fff; color: #000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            
            #vertical-controls { bottom: 30px; right: 15px; }
            .v-control-btn:hover { width: 40px; padding-left: 0; background: #fff; color: #555; }
            .v-control-btn:hover span { opacity: 0; }
            .v-control-btn.active-control { background: #222; color: #fff; }
            
            #time-widget { bottom: 40px; width: 85%; padding: 25px; }
            
            /* COMPACT MOBILE TOAST */
            #toast { 
                bottom: 80px; 
                width: auto; 
                max-width: 80%;
                justify-content: center; 
                padding: 8px 16px; 
                font-size: 11px;
            }
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="tooltip"></div> 
    
    <div id="time-widget">
        <div class="widget-close" onclick="closeTimeWidget()">×</div>
        <div id="year-display">Present Day</div>
        <div class="range-labels">
            <span id="label-min">1850</span>
            <span>Present</span>
        </div>
    </div>

    <div id="toast">
        <i class="fa-solid fa-info-circle"></i>
        <span id="toast-msg">Welcome to Kala Ghoda</span>
    </div>

    <div id="header">
        <h1>
            <span class="title-sub">Visual Audit</span>
            <span class="title-main">Kala Ghoda</span>
        </h1>
        <h2>Heritage Survey</h2>
        
        <div id="search-container">
            <div class="search-wrapper">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Search buildings, styles..." autocomplete="off">
            </div>
            <div id="search-results"></div>
        </div>

        <div id="console">
            <div id="layers-header">
                <span><i class="fa-solid fa-layer-group"></i> Filter Layers</span>
                <i class="fa-solid fa-chevron-down" id="layers-arrow"></i>
            </div>
            
            <div id="layers-content" class="collapsed">
            </div>
        </div>
    </div>

    <div id="vertical-controls">
        <!-- Removed data-msg for Zoom controls to disable toast -->
        <button class="v-control-btn" id="zoom-in-btn"><i class="fa-solid fa-plus"></i> <span>Zoom In</span></button>
        <button class="v-control-btn" id="zoom-out-btn"><i class="fa-solid fa-minus"></i> <span>Zoom Out</span></button>
        <button class="v-control-btn" id="compass-btn" data-msg="Orientation Reset"><i class="fa-regular fa-compass"></i> <span>Reset North</span></button>
        <button class="v-control-btn" id="time-travel-btn" data-msg="Time Slider Active"><i class="fa-solid fa-clock-rotate-left"></i> <span>Time Travel</span></button>
        <button class="v-control-btn" id="map-1883-btn" data-msg="1883 Map Enabled"><i class="fa-solid fa-map-location-dot"></i> <span>1883 Map</span></button>
        <button class="v-control-btn" id="view-3d-btn" data-msg="3D View Toggled"><i class="fa-solid fa-cube"></i> <span>3D View</span></button>
        <button class="v-control-btn" id="reset-view-btn" data-msg="Camera Reset"><i class="fa-solid fa-compress"></i> <span>Reset View</span></button>
        <button class="v-control-btn" id="locate-btn" data-msg="Locating..."><i class="fa-solid fa-location-crosshairs"></i> <span>My Location</span></button>
    </div>

    <div id="side-panel">
        <button class="panel-close" id="close-btn">×</button>
        <div id="panel-scroll-area">
            <div id="panel-inner"></div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            initMap();
            // Only show intro toast on desktop
            if(window.innerWidth > 768) {
                showToast("Try the Time Travel slider!", 2000);
            }
        });
        
        function showToast(message, duration = 2000) {
            var toast = document.getElementById('toast');
            var msg = document.getElementById('toast-msg');
            msg.innerText = message;
            toast.classList.add('show');
            clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(function() { toast.classList.remove('show'); }, duration);
        }

        function initMap() {
            var initialZoom = window.innerWidth < 768 ? 15.0 : 16.5;

            var config = {
                style: 'https://api.maptiler.com/maps/019b6fe6-78c4-7dcb-b6eb-fed1b18171df/style.json?key=f0f0aibL2C05fTzSrqHq', 
                colors: { 'Art Deco': '#2a9d8f', 'Victorian': '#e76f51', 'Modern': '#264653', 'Lettering': '#7b2cbf', 'Ghost Site': '#95a5a6', 'Street Furniture': '#4a69bd', 'Living Heritage': '#27ae60' },
                icons: { 'Art Deco': 'fa-building', 'Victorian': 'fa-landmark', 'Modern': 'fa-square', 'Lettering': 'fa-font', 'Ghost Site': 'fa-ghost', 'Street Furniture': 'fa-road', 'Living Heritage': 'fa-users' },
                chapters: [
                    { id: 'regal', category: 'Art Deco', title: 'Regal Cinema', image: './images/regal.jpg', description: 'One of the earliest Art Deco cinemas in India.', year: '1933', architect: 'Charles Stevens', builder: 'Framji Sidhwa', location: { center: [72.8325, 18.9246] } },
                    { id: 'museum', category: 'Victorian', title: 'CSMVS Museum', image: './images/csmvs.jpg', description: 'Indo Saracenic landmark constructed using grey Kurla basalt.', year: '1914', architect: 'George Wittet', builder: 'Govt. of Bombay', location: { center: [72.8322, 18.9269] } },
                    { id: 'elphinstone', category: 'Victorian', title: 'Elphinstone College', image: './images/elphinstone.jpg', description: 'Victorian Gothic Revival building with pointed arches.', year: '1871', architect: 'James Trubshawe', builder: 'Unknown', location: { center: [72.8309, 18.9271] } },
                    { id: 'sassoon', category: 'Victorian', title: 'David Sassoon Library', image: './images/sassoon.jpg', description: 'Victorian Gothic architecture defined by pointed arches.', year: '1870', architect: 'Campbell & Gosling', builder: 'Scott McClelland', location: { center: [72.8311, 18.9277] } },
                    { id: 'army', category: 'Victorian', title: 'Army and Navy Building', image: './images/army-navy.jpg', description: 'Late nineteenth century Neo Classical commercial building.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8313, 18.9282] } },
                    { id: 'esplanade', category: 'Victorian', title: 'Esplanade Mansion', image: './images/esplanade.jpg', description: 'Formerly Watson\'s Hotel. One of the earliest cast iron framed buildings.', year: '1865', architect: 'Rowland Mason Ordish', builder: 'British Engineers', location: { center: [72.8311, 18.9283] } },
                    { id: 'jehangir', category: 'Modern', title: 'Jehangir Art Gallery', image: './images/jehangir.jpg', description: 'Modernist concrete structure with a distinctive cantilevered entrance.', year: '1952', architect: 'G. M. Bhuta', builder: 'Sir Cowasji Jehangir', location: { center: [72.8317, 18.9275] } },
                    { id: 'statue', category: 'Street Furniture', title: 'Kala Ghoda Statue', image: './images/placeholder.jpg', description: 'Bronze statue installed to mark the historic site.', year: '2017', architect: 'Commissioned artwork', builder: 'Kala Ghoda Association', location: { center: [72.8318, 18.9279] } },
                    { id: 'synagogue', category: 'Victorian', title: 'Keneseth Eliyahoo', image: './images/synagogue.jpg', description: 'Victorian era synagogue built for the Baghdadi Jewish community.', year: '1884', architect: 'Unknown', builder: 'Jewish Community', location: { center: [72.8326, 18.9281] } },
                    { id: 'ropewalk', category: 'Street Furniture', title: 'Rope Walk Lane', image: './images/ropewalk.jpg', description: 'Historic lane characterised by enamel street signage.', year: '19th century', architect: 'Incremental', builder: 'Multiple', location: { center: [72.8323, 18.9278] } },
                    { id: 'army-lettering', category: 'Lettering', title: 'Army and Navy Signage', image: './images/army-lettering.jpg', description: 'Original carved and painted serif lettering.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.83135, 18.9282] } }, /* Offset applied here */
                    { id: 'ropewalk-signs', category: 'Lettering', title: 'Rope Walk Signs', image: './images/ropewalk-lettering.jpg', description: 'Blue enamel street signage with bilingual lettering.', year: '20th century', architect: 'Municipal signage', builder: 'BMC', location: { center: [72.83235, 18.9278] } }, /* Offset applied here */
                    { id: 'lumiere', category: 'Ghost Site', title: 'Lumière Screening Site', image: './images/lumiere-placeholder.jpg', description: 'On July 7, 1896, the Lumière Brothers screened the first motion pictures.', year: '1896', architect: 'N/A', builder: 'Historic Event', location: { center: [72.83125, 18.92835] } },
                    { id: 'hydrant', category: 'Street Furniture', title: 'British Fire Hydrant', image: './images/hydrant.jpg', description: 'A cast-iron fire hydrant from the Bombay Municipal Corporation era.', year: 'Late 19th C.', architect: 'BMC', builder: 'Foundry Cast', location: { center: [72.8325, 18.9276] } },
                    { id: 'pavement', category: 'Living Heritage', title: 'The Pavement Gallery', image: './images/pavement.jpg', description: 'An informal exhibition space where aspiring artists display their work.', year: 'Ongoing', architect: 'The People', builder: 'Informal Usage', location: { center: [72.83165, 18.92745] } }, /* Offset applied here */
                    { id: 'booksellers', category: 'Living Heritage', title: 'Secondhand Book Sellers', image: './images/books.jpg', description: 'The lineage of street book vendors near Flora Fountain.', year: 'Mid 20th C.', architect: 'N/A', builder: 'Vendor Collective', location: { center: [72.8305, 18.9290] } },
                    { id: 'kerbstones', category: 'Street Furniture', title: 'Kurla Basalt Kerbstones', image: './images/kerb.jpg', description: 'Original massive blocks of grey Kurla basalt lining the pavement.', year: '19th Century', architect: 'City Engineers', builder: 'Public Works', location: { center: [72.8320, 18.9275] } },
                    { id: 'rhythm', category: 'Ghost Site', title: 'Rhythm House', image: './images/rhythm-house.jpg', description: 'Formerly the city\'s premier music store.', year: '1940s', architect: 'Unknown', builder: 'Mehmood Curmally', location: { center: [72.8318, 18.9272] } },
                    { id: 'wayside', category: 'Ghost Site', title: 'Wayside Inn', image: './images/wayside.jpg', description: 'Now the Khyber restaurant. Famous quaint tea room.', year: 'Early 20th C.', architect: 'N/A', builder: 'Historic Site', location: { center: [72.8317, 18.9286] } }
                ]
            };

            function parseYear(yearStr) {
                if (!yearStr) return 2025; 
                yearStr = yearStr.toString().toLowerCase();
                var match = yearStr.match(/(\d{4})/);
                if (match) return parseInt(match[0]);
                if (yearStr.includes('late 19th')) return 1890;
                if (yearStr.includes('mid 19th')) return 1850;
                if (yearStr.includes('early 19th')) return 1810;
                if (yearStr.includes('19th century')) return 1850;
                if (yearStr.includes('early 20th')) return 1910;
                if (yearStr.includes('mid 20th')) return 1950;
                if (yearStr.includes('late 20th')) return 1990;
                if (yearStr.includes('20th century')) return 1950;
                return 2025; 
            }

            // --- STATE MANAGEMENT ---
            var disabledCategories = [];
            var currentSliderYear = 2025;
            var isTimeTravelActive = false;

            var layersContent = document.getElementById('layers-content');
            var categories = [...new Set(config.chapters.map(function(item) { return item.category; }))];
            
            var allBtn = document.createElement('div');
            allBtn.className = 'filter-btn all-layers-btn active';
            allBtn.innerHTML = 'Reset Visibility';
            allBtn.onclick = function() { resetFilters(); };
            layersContent.appendChild(allBtn);

            categories.forEach(function(cat) {
                var btn = document.createElement('div'); 
                btn.className = 'filter-btn'; 
                btn.setAttribute('data-cat', cat);
                var color = config.colors[cat] || '#333';
                
                // New layout with separate actions
                btn.innerHTML = `
                    <div class="layer-label-group">
                        <span class="dot-indicator" style="color:${color}"></span>
                        <span>${cat}</span>
                    </div>
                    <div class="layer-actions">
                        <span class="layer-solo-btn" title="Show Only This Layer">ONLY</span>
                        <div class="layer-eye-btn" title="Toggle Visibility"><i class="fa-regular fa-eye"></i></div>
                    </div>
                `;
                
                // Click on label toggles visibility
                btn.querySelector('.layer-label-group').addEventListener('click', function() {
                    toggleCategory(cat, btn);
                });

                // Click on Eye toggles visibility
                btn.querySelector('.layer-eye-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleCategory(cat, btn);
                });

                // Click on ONLY button
                var soloBtn = btn.querySelector('.layer-solo-btn');
                soloBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    soloCategory(cat, soloBtn);
                });

                layersContent.appendChild(btn);
            });

            var mobileFilterBtn = document.createElement('div');
            mobileFilterBtn.id = 'mobile-filter-toggle';
            mobileFilterBtn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
            mobileFilterBtn.style.display = 'none';
            document.getElementById('search-container').appendChild(mobileFilterBtn);

            mobileFilterBtn.onclick = function() {
                var consolePanel = document.getElementById('console');
                var isOpen = consolePanel.classList.contains('open');
                if (isOpen) {
                    consolePanel.classList.remove('open');
                    this.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                    this.style.background = '#fff';
                    this.style.color = '#333';
                } else {
                    consolePanel.classList.add('open');
                    this.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                    this.style.background = '#333';
                    this.style.color = '#fff';
                    closePanel(true);
                }
            };

            function toggleCategory(cat, btn) {
                if (document.body.classList.contains('mode-1883')) return;
                var icon = btn.querySelector('.layer-eye-btn i');
                
                if (disabledCategories.includes(cat)) {
                    // Turn ON
                    disabledCategories = disabledCategories.filter(c => c !== cat);
                    btn.classList.remove('layer-hidden');
                    icon.className = 'fa-regular fa-eye';
                } else {
                    // Turn OFF
                    disabledCategories.push(cat);
                    btn.classList.add('layer-hidden');
                    icon.className = 'fa-regular fa-eye-slash';
                }
                
                // If we are manually toggling, clear any "Solo" active states
                document.querySelectorAll('.layer-solo-btn').forEach(b => b.classList.remove('active-solo'));
                
                updateMapState();
            }

            function soloCategory(targetCat, soloBtnElement) {
                if (document.body.classList.contains('mode-1883')) return;
                
                // Check if this button is already active
                if (soloBtnElement.classList.contains('active-solo')) {
                    // It was active, so we are de-activating (Resetting)
                    resetFilters();
                    return;
                }

                // Activate logic
                disabledCategories = categories.filter(c => c !== targetCat);
                var allBtns = document.querySelectorAll('.filter-btn[data-cat]');
                
                allBtns.forEach(b => {
                    var cat = b.getAttribute('data-cat');
                    var icon = b.querySelector('.layer-eye-btn i');
                    var currentSoloBtn = b.querySelector('.layer-solo-btn');
                    
                    if (cat === targetCat) {
                        b.classList.remove('layer-hidden');
                        icon.className = 'fa-regular fa-eye';
                        currentSoloBtn.classList.add('active-solo'); // Set Blue
                    } else {
                        b.classList.add('layer-hidden');
                        icon.className = 'fa-regular fa-eye-slash';
                        currentSoloBtn.classList.remove('active-solo'); // Remove Blue
                    }
                });
                updateMapState();
            }

            function resetFilters() {
                if (document.body.classList.contains('mode-1883')) return;
                disabledCategories = [];
                var btns = document.querySelectorAll('.filter-btn:not(.all-layers-btn)');
                btns.forEach(b => {
                    b.classList.remove('layer-hidden');
                    var icon = b.querySelector('.layer-eye-btn i');
                    if(icon) icon.className = 'fa-regular fa-eye';
                    
                    var solo = b.querySelector('.layer-solo-btn');
                    if(solo) solo.classList.remove('active-solo');
                });
                updateMapState();
            }

            function updateMapState() {
                markerObjects.forEach(function(m) {
                    var categoryVisible = !disabledCategories.includes(m.category);
                    var timeVisible = m.year <= currentSliderYear;
                    if (categoryVisible && timeVisible) {
                        m.element.style.display = 'flex';
                        m.element.style.opacity = '1';
                    } else {
                        m.element.style.display = 'none';
                    }
                });
                if (selectedMarker && selectedMarker.style.display === 'none') {
                    closePanel(false);
                }
            }

            var separator = document.createElement('div');
            separator.className = 'console-separator';
            layersContent.appendChild(separator);

            var wallBtn = document.createElement('div');
            wallBtn.id = 'wall-btn';
            wallBtn.className = 'filter-btn';
            wallBtn.innerHTML = '<div class="layer-label-group"><i class="fa-solid fa-archway"></i> Toggle 1860 Fort Wall</div>';
            wallBtn.onclick = function() { toggleLayer('fort-wall-layer', this); };
            layersContent.appendChild(wallBtn);
            
            // RESTORED WALL INFO BOX
            var wallInfo = document.createElement('div');
            wallInfo.id = 'wall-info';
            wallInfo.innerHTML = '<strong>The Invisible Ramparts</strong>This dashed line traces the demolished fortifications of the Bombay Fort (removed 1862).';
            layersContent.appendChild(wallInfo);

            var layersHeader = document.getElementById('layers-header');
            var layersArrow = document.getElementById('layers-arrow');
            layersHeader.addEventListener('click', function() {
                if (layersContent.classList.contains('collapsed')) {
                    layersContent.classList.remove('collapsed');
                    layersArrow.classList.add('rotated'); 
                } else {
                    layersContent.classList.add('collapsed');
                    layersArrow.classList.remove('rotated'); 
                }
            });

            var map = new maplibregl.Map({
                container: 'map',
                style: config.style,
                center: [72.8320, 18.9275], 
                zoom: initialZoom,
                minZoom: 14.5, 
                maxBounds: [[72.8100, 18.9100], [72.8500, 18.9450]],
                pitch: 45, bearing: -15, antialias: true, attributionControl: false
            });
            
            map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
            map.addControl(new maplibregl.ScaleControl({ maxWidth: 100, unit: 'metric' }), 'bottom-left');

            // --- TIME TRAVEL LOGIC ---
            var parsedYears = config.chapters.map(c => parseYear(c.year)).filter(y => !isNaN(y) && y !== 2025);
            var minYear = parsedYears.length > 0 ? Math.min(...parsedYears) : 1850;
            var maxYear = 2025;
            
            document.getElementById('label-min').innerText = minYear;

            var timeWidget = document.getElementById('time-widget');
            var sliderInput = document.createElement('input');
            sliderInput.type = 'range';
            sliderInput.min = minYear;
            sliderInput.max = maxYear;
            sliderInput.value = maxYear;
            sliderInput.id = 'year-slider';
            
            timeWidget.insertBefore(sliderInput, timeWidget.querySelector('.range-labels'));

            sliderInput.addEventListener('input', function(e) {
                var year = parseInt(e.target.value);
                var display = document.getElementById('year-display');
                if (year === parseInt(e.target.max)) display.innerText = "Present Day";
                else display.innerText = "Year: " + year;
                currentSliderYear = year;
                updateMapState();
            });

            window.closeTimeWidget = function() {
                document.getElementById('time-widget').classList.remove('active');
                document.getElementById('time-travel-btn').classList.remove('active-control');
                isTimeTravelActive = false;
            };

            document.getElementById('time-travel-btn').addEventListener('click', function() {
                var widget = document.getElementById('time-widget');
                var btn = this;
                
                // If 1883 mode is on, we cannot use time travel
                if (document.body.classList.contains('mode-1883')) {
                    if(window.innerWidth <= 768) showToast("Time Travel unavailable in 1883 Mode");
                    return;
                }

                if (widget.classList.contains('active')) {
                    closeTimeWidget();
                } else {
                    widget.classList.add('active');
                    btn.classList.add('active-control');
                    isTimeTravelActive = true;
                }
            });

            function setupControl(id, action) {
                var btn = document.getElementById(id);
                btn.addEventListener('click', function() {
                    // Prevent other actions if 1883 mode is on (except exit)
                    if(document.body.classList.contains('mode-1883') && id !== 'map-1883-btn' && id !== 'zoom-in-btn' && id !== 'zoom-out-btn' && id !== 'compass-btn') {
                        return;
                    }

                    action();
                    if (window.innerWidth <= 768) {
                        var msg = btn.getAttribute('data-msg');
                        if(msg) showToast(msg);
                    }
                });
            }

            setupControl('zoom-in-btn', () => map.zoomIn());
            setupControl('zoom-out-btn', () => map.zoomOut());
            
            var view3dBtn = document.getElementById('view-3d-btn');
            map.on('pitch', function() {
                var pitch = map.getPitch();
                if (pitch > 5) {
                    view3dBtn.classList.add('active-control');
                } else {
                    view3dBtn.classList.remove('active-control');
                }
            });

            setupControl('compass-btn', () => { 
                map.flyTo({ bearing: 0, pitch: 0 }); 
            });

            setupControl('view-3d-btn', () => {
                var currentPitch = map.getPitch();
                if (currentPitch > 5) { map.easeTo({ pitch: 0, bearing: 0 }); } 
                else { map.easeTo({ pitch: 45, bearing: -15 }); }
            });

            setupControl('reset-view-btn', () => { 
                map.flyTo({ center: [72.8320, 18.9275], zoom: initialZoom, pitch: 45, bearing: -15, duration: 2000 }); 
                closePanel(true); 
            });

            // --- 1883 MAP BUTTON (EXCLUSIVE MODE) ---
            setupControl('map-1883-btn', function() {
                toggle1883Map(document.getElementById('map-1883-btn'));
            });

            var geolocate = new maplibregl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true });
            map.addControl(geolocate); 
            setupControl('locate-btn', () => geolocate.trigger());

            window.mapInstance = map;
            var markerObjects = [];
            var selectedMarker = null;
            var tooltip = document.getElementById('tooltip');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', function(e) {
                const val = e.target.value.toLowerCase();
                if (val.length < 1) { searchResults.style.display = 'none'; return; }
                const matches = config.chapters.filter(item => item.title.toLowerCase().includes(val) || item.category.toLowerCase().includes(val));
                searchResults.innerHTML = ''; 
                searchResults.style.display = 'block';
                if (matches.length > 0) {
                    matches.forEach(item => {
                        const div = document.createElement('div'); div.className = 'search-item';
                        div.innerHTML = `<span class="search-item-title">${item.title}</span><span class="search-item-cat">${item.category}</span>`;
                        div.addEventListener('click', () => { 
                            const targetObj = markerObjects.find(obj => obj.id === item.id); 
                            if (targetObj) { 
                                targetObj.element.click(); 
                                searchInput.value = ''; 
                                searchResults.style.display = 'none'; 
                                if(window.innerWidth <= 768) { document.getElementById('search-input').blur(); }
                            } 
                        });
                        searchResults.appendChild(div);
                    });
                } else { searchResults.innerHTML = '<div class="search-empty">No results found</div>'; }
            });
            document.addEventListener('click', function(e) { if (!document.getElementById('search-container').contains(e.target)) { searchResults.style.display = 'none'; } });

            // ESCAPE KEY LOGIC
            document.addEventListener('keydown', function(event) {
                if (event.key === "Escape") {
                    if (document.body.classList.contains('mode-1883')) {
                        toggle1883Map(document.getElementById('map-1883-btn'));
                    } else {
                        closePanel(false);
                    }
                }
            });

            map.on("load", function () {
                map.setSky({ 'sky-color': '#87CEEB', 'sky-horizon-blend': 0.5, 'horizon-color': '#ffffff', 'fog-color': '#888888', 'fog-ground-blend': 0.5 });
                
                var layers = map.getStyle().layers;
                layers.forEach(function(layer) {
                    if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                        map.setLayoutProperty(layer.id, 'text-font', ['Noto Serif Regular', 'Open Sans Regular', 'Arial Unicode MS Regular']);
                    }
                });

                map.addSource('source-1883', { 'type': 'image', 'url': './images/fort-1883.jpg', 'coordinates': [[72.8228, 18.9435], [72.8492, 18.9435], [72.8492, 18.9235], [72.8228, 18.9235]] });
                map.addLayer({ 'id': 'layer-1883', 'type': 'raster', 'source': 'source-1883', 'paint': { 'raster-fade-duration': 0 }, 'layout': { 'visibility': 'none' } });

                map.addLayer({ 'id': '3d-buildings', 'source': 'openmaptiles', 'source-layer': 'building', 'type': 'fill-extrusion', 'minzoom': 15, 'paint': { 'fill-extrusion-color': '#f0f0f0', 'fill-extrusion-height': ['get', 'render_height'], 'fill-extrusion-base': ['get', 'render_min_height'], 'fill-extrusion-opacity': 0.9 } });

                var fortWallGeoJSON = { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[72.8312, 18.9278], [72.8318, 18.9276], [72.8325, 18.9273], [72.8335, 18.9268], [72.8342, 18.9265]] } };
                map.addSource('fort-wall', { 'type': 'geojson', 'data': fortWallGeoJSON });
                map.addLayer({ 'id': 'fort-wall-layer', 'type': 'line', 'source': 'fort-wall', 'layout': { 'line-join': 'round', 'line-cap': 'round', 'visibility': 'none' }, 'paint': { 'line-color': '#c0392b', 'line-width': 4, 'line-dasharray': [2, 4] } });

                config.chapters.forEach(function(record) {
                    var color = config.colors[record.category] || '#333';
                    var iconClass = config.icons[record.category] || 'fa-map-marker-alt';
                    var el = document.createElement('div'); el.className = 'marker'; el.style.backgroundColor = color; el.innerHTML = '<i class="fa-solid ' + iconClass + '"></i>';
                    record.parsedYear = parseYear(record.year);
                    el.onclick = function(e) { e.stopPropagation(); openPanel(record, color, el); };
                    if (window.matchMedia('(hover: hover)').matches) {
                        el.addEventListener('mouseenter', function(e) { tooltip.innerText = record.title; var rect = el.getBoundingClientRect(); tooltip.style.left = rect.left + (rect.width / 2) + 'px'; tooltip.style.top = rect.top + 'px'; tooltip.style.opacity = '1'; });
                        el.addEventListener('mouseleave', function() { tooltip.style.opacity = '0'; });
                    }
                    var marker = new maplibregl.Marker({ element: el, anchor: 'bottom' }).setLngLat(record.location.center).addTo(map);
                    markerObjects.push({ element: el, category: record.category, marker: marker, id: record.id, title: record.title, year: record.parsedYear });
                });
            });

            // Map click closes panels AND Mobile Drawer
            map.on('click', function() { 
                closePanel(false); 
                document.getElementById('console').classList.remove('open');
                var btn = document.getElementById('mobile-filter-toggle');
                if(btn) {
                    btn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                    btn.style.background = '#fff';
                    btn.style.color = '#333';
                }
            });

            function openPanel(record, color, markerEl) {
                if (selectedMarker) selectedMarker.classList.remove('selected');
                markerEl.classList.add('selected');
                selectedMarker = markerEl;
                var infoHTML = '<div class="panel-info">' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Year</span><span class="panel-info-val">' + record.year + '</span></div>' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Architect</span><span class="panel-info-val">' + record.architect + '</span></div>' + 
                    '<div class="panel-info-row"><span class="panel-info-label">Builder</span><span class="panel-info-val">' + record.builder + '</span></div>' + 
                '</div>';
                var destLat = record.location.center[1]; var destLng = record.location.center[0];
                var navUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
                var navButton = `<a href="${navUrl}" target="_blank" class="panel-action-btn"><i class="fa-solid fa-diamond-turn-right"></i> Navigate Here</a>`;
                var imageHTML = `<div class="panel-img-container"><img src="${record.image}" class="panel-img"></div>`;
                var panelContent = imageHTML + '<div class="panel-content"><span class="panel-cat" style="color:' + color + '">' + record.category + '</span><div class="panel-title">' + record.title + '</div><p class="panel-desc">' + record.description + '</p>' + infoHTML + navButton + '</div>';
                document.getElementById('panel-inner').innerHTML = panelContent; 
                document.getElementById('side-panel').classList.add('open');
                if(window.innerWidth <= 768) {
                    document.getElementById('console').classList.remove('open');
                    var filterBtn = document.getElementById('mobile-filter-toggle');
                    if(filterBtn) {
                        filterBtn.innerHTML = '<i class="fa-solid fa-layer-group"></i>';
                        filterBtn.style.background = '#fff';
                        filterBtn.style.color = '#333';
                    }
                }
                if (window.innerWidth >= 768) {
                    map.flyTo({ center: record.location.center, zoom: 17.5, pitch: map.getPitch(), bearing: map.getBearing(), speed: 0.8, curve: 1 });
                }
            }

            function closePanel(preventCameraMove) {
                document.getElementById('side-panel').classList.remove('open');
                if (selectedMarker) { selectedMarker.classList.remove('selected'); selectedMarker = null; }
                if (!preventCameraMove && window.innerWidth >= 768) { map.flyTo({ zoom: initialZoom, speed: 0.6 }); }
            }

            document.getElementById('close-btn').addEventListener('click', function() {
                closePanel(false);
            });

            window.toggleLayer = function(layerId, btn) {
                if (document.body.classList.contains('mode-1883')) return;
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var infoBox = document.getElementById('wall-info');
                
                if (visibility === 'visible') { 
                    // Turn OFF
                    map.setLayoutProperty(layerId, 'visibility', 'none'); 
                    btn.classList.remove('active-control'); 
                    infoBox.style.display = 'none';
                } else { 
                    // Turn ON
                    map.setLayoutProperty(layerId, 'visibility', 'visible'); 
                    btn.classList.add('active-control'); 
                    infoBox.style.display = 'block';
                }
            };

            window.toggle1883Map = function(btn) {
                var layerId = 'layer-1883';
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var body = document.body;
                
                if (visibility === 'visible') {
                    // Turn OFF
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                    btn.classList.remove('active-control');
                    body.classList.remove('mode-1883');
                    // Restore 3D view check? No, let user decide.
                    updateMapState();
                } else {
                    // Turn ON: EXCLUSIVE MODE
                    
                    // 1. Close Time Widget
                    closeTimeWidget();
                    
                    // 2. Clear Search
                    document.getElementById('search-input').value = '';
                    document.getElementById('search-results').style.display = 'none';
                    
                    // 3. FIT BOUNDS (The Fix)
                    map.fitBounds([
                        [72.8228, 18.9235], // Southwest coordinates
                        [72.8492, 18.9435]  // Northeast coordinates
                    ], {
                        padding: {top: 100, bottom: 100, left: 50, right: 50}, // Adjust for header
                        pitch: 0,
                        bearing: 0
                    });

                    // 4. Activate Mode
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                    btn.classList.add('active-control');
                    body.classList.add('mode-1883');
                    
                    // 5. Hide Markers
                    markerObjects.forEach(function(m) { m.element.style.display = 'none'; });
                    
                    // 6. Close panel
                    closePanel(true);
                    
                    // 7. Feedback
                    if (window.innerWidth <= 768) showToast("1883 Mode Active: Other tools disabled");
                }
            };
        }
    </script>
</body>
</html>