<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visual Audit: Kala Ghoda</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* --- THEME: MUSEUM ARCHIVE --- */
        :root {
            --bg: #ffffff;
            --text-main: #111;
            --text-sub: #555;
            --border: #ddd;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --accent-wall: #c0392b;
            --accent-nav: #2980b9; /* New Color for Navigation */
        }
        
        body { margin: 0; padding: 0; font-family: 'Lato', sans-serif; overflow: hidden; background: #eee; }
        
        #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }

        .maplibregl-canvas-container canvas {
            filter: sepia(0.15) contrast(0.95);
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; }

        /* --- UI: HEADER --- */
        #header {
            position: absolute; top: 30px; left: 30px; 
            width: auto; max-width: 420px;
            background: var(--bg);
            z-index: 100;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-radius: 2px; 
        }

        #header h1 { 
            font-family: 'Cardo', serif; 
            font-size: 22px; font-weight: 400; 
            color: var(--text-main);
            padding: 20px 20px 5px 20px; margin: 0; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        #header h2 { 
            font-family: 'Lato', sans-serif; font-size: 10px; color: var(--text-sub); 
            padding: 0 20px 15px 20px; margin: 0; text-transform: uppercase; letter-spacing: 2px; 
            font-weight: 700; border-bottom: 1px solid var(--border);
        }

        /* --- UI: FILTERS --- */
        #console { 
            padding: 15px 20px 20px 20px; 
            display: flex; flex-wrap: wrap; gap: 8px; 
        }
        .filter-btn {
            padding: 6px 12px;
            font-size: 10px;
            text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
            border: 1px solid var(--border); 
            background: #fff; 
            color: var(--text-sub); cursor: pointer; 
            border-radius: 2px;
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 5px;
        }
        .filter-btn:hover { border-color: #999; color: #000; }
        .filter-btn.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }
        
        #wall-btn {
            margin-top: 5px; 
            border: 1px dashed var(--accent-wall);
            color: var(--accent-wall);
            width: 100%; justify-content: center;
        }
        #wall-btn:hover { background: #fff5f5; }
        #wall-btn.active { background: var(--accent-wall); color: #fff; border-style: solid; }

        #wall-info {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #fff5f5;
            border-left: 3px solid var(--accent-wall);
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        #wall-info strong { display: block; margin-bottom: 3px; color: var(--accent-wall); }

        .dot-indicator { width: 6px; height: 6px; border-radius: 50%; display: inline-block; background: currentColor; }

        /* --- UI: MARKERS --- */
        .marker {
            width: 30px; height: 30px;
            border-radius: 50%;
            border: 2px solid #fff; 
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #fff; 
            transition: transform 0.2s ease;
            z-index: 10;
        }
        .marker:hover { transform: scale(1.15); z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .marker.selected { 
            transform: scale(1.2); z-index: 30;
            box-shadow: 0 0 0 2px #fff, 0 4px 15px rgba(0,0,0,0.3); 
        }

        #tooltip {
            position: absolute; pointer-events: none;
            background: #111; color: #fff;
            padding: 5px 10px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            border-radius: 2px; opacity: 0;
            transform: translate(-50%, -10px);
            transition: opacity 0.2s, transform 0.2s; 
            z-index: 500; white-space: nowrap;
        }
        
        /* --- UI: SIDE PANEL --- */
        #side-panel {
            position: fixed; right: -450px; top: 0; bottom: 0; width: 400px;
            background: #fff;
            z-index: 200;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
            transition: right 0.6s cubic-bezier(0.19, 1, 0.22, 1); 
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        #side-panel.open { right: 0; }
        
        #panel-scroll-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        .panel-img-container { position: relative; width: 100%; height: 300px; overflow: hidden; background: #eee; }
        .panel-img { width: 100%; height: 100%; object-fit: cover; filter: saturate(0.9); transition: transform 6s ease; }
        #side-panel.open .panel-img { transform: scale(1.05); } 
        
        .panel-content { padding: 40px; }
        
        .panel-cat {
            font-size: 10px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700;
            color: #888; margin-bottom: 15px; display: inline-block;
            border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        .panel-title {
            font-family: 'Cardo', serif; 
            font-size: 32px; font-weight: 400; 
            margin-bottom: 25px; color: var(--text-main); line-height: 1.1;
        }
        .panel-desc { 
            font-size: 15px; color: #444; line-height: 1.7; margin-bottom: 40px; 
            font-family: 'Cardo', serif; 
        }
        
        .panel-info { display: table; width: 100%; border-top: 1px solid var(--border); padding-top: 20px; }
        .panel-info-row { display: table-row; }
        .panel-info-label { display: table-cell; padding: 6px 0; font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 1px; width: 30%; }
        .panel-info-val { display: table-cell; padding: 6px 0; font-size: 13px; color: #111; font-weight: 400; }

        /* NAVIGATION BUTTON STYLE */
        .panel-action-btn {
            display: block; width: 100%; 
            margin-top: 20px; padding: 12px 0;
            text-align: center; text-decoration: none;
            background: #fff; border: 1px solid var(--accent-nav);
            color: var(--accent-nav);
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border-radius: 2px; transition: all 0.2s;
        }
        .panel-action-btn:hover { background: var(--accent-nav); color: #fff; }

        .panel-close {
            position: absolute; top: 20px; right: 20px; width: 36px; height: 36px;
            background: rgba(255,255,255,0.9); color: #000; border: none;
            cursor: pointer; font-size: 20px; z-index: 300;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; backdrop-filter: blur(4px);
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel-close:hover { background: #000; color: #fff; }

        /* --- FLOATING CONTROLS --- */
        .control-group {
            position: fixed; top: 30px; right: 80px; 
            display: flex; gap: 8px; z-index: 90;
        }

        .map-control-btn {
            background: #fff; color: #111; border: 1px solid var(--border);
            padding: 8px 14px; 
            font-family: 'Lato', sans-serif; font-weight: 700; font-size: 10px; letter-spacing: 1px;
            cursor: pointer; box-shadow: var(--shadow);
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; border-radius: 2px;
        }
        .map-control-btn:hover { background: #111; color: #fff; border-color: #111; }
        .map-control-btn.active { background: var(--text-main); color: #fff; }

        .maplibregl-ctrl-scale {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid var(--border) !important;
            color: #333 !important;
            font-family: 'Lato', sans-serif !important;
            font-size: 10px !important;
            border-radius: 2px !important;
            box-shadow: none !important;
        }

        @media (max-width: 768px) {
            #header { top: 15px; left: 15px; right: 15px; width: auto; max-width: none; }
            #header h1 { font-size: 18px; padding: 15px 15px 5px 15px; }
            #header h2 { padding: 0 15px 10px 15px; border: none; }
            #console { padding: 0 15px 15px 15px; }
            #side-panel { right: auto; left: 0; bottom: -100vh; top: auto; width: 100%; height: 75vh; border-left: none; border-top: 1px solid #ccc; border-radius: 12px 12px 0 0; }
            #side-panel.open { bottom: 0; }
            .panel-content { padding: 25px; }
            .panel-title { font-size: 24px; margin-bottom: 15px; }
            .panel-desc { font-size: 14px; margin-bottom: 25px; }
            .panel-img-container { height: 200px; }
            
            .control-group { top: auto; bottom: 30px; right: 20px; flex-direction: column-reverse; }
            .filter-btn { padding: 6px 10px; font-size: 10px; margin-bottom: 2px;}
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="tooltip"></div> 
    
    <div id="header">
        <h1>Visual Audit: Kala Ghoda</h1>
        <h2>Heritage Survey</h2>
        <div id="console"></div>
    </div>

    <div class="control-group">
        <button id="view-btn" class="map-control-btn"><i class="fa-solid fa-cube"></i> 3D View</button>
        <button id="reset-btn" class="map-control-btn"><i class="fa-solid fa-compress"></i> Reset</button>
    </div>

    <div id="side-panel">
        <button class="panel-close" id="close-btn">×</button>
        <div id="panel-scroll-area">
            <div id="panel-inner"></div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            initMap();
        });

        function initMap() {
            var initialZoom = window.innerWidth < 768 ? 15.0 : 16.5;

            var config = {
                style: 'https://api.maptiler.com/maps/019b6fe6-78c4-7dcb-b6eb-fed1b18171df/style.json?key=f0f0aibL2C05fTzSrqHq', 
                
                colors: {
                    'Art Deco': '#2a9d8f', 'Victorian': '#e76f51', 'Modern': '#264653',
                    'Lettering': '#7b2cbf', 'Ghost Site': '#95a5a6', 'Street Furniture': '#4a69bd', 'Living Heritage': '#27ae60'
                },
                
                icons: {
                    'Art Deco': 'fa-building', 'Victorian': 'fa-landmark', 'Modern': 'fa-square',
                    'Lettering': 'fa-font', 'Ghost Site': 'fa-ghost', 'Street Furniture': 'fa-road', 'Living Heritage': 'fa-users'
                },
                
                chapters: [
                    { id: 'regal', category: 'Art Deco', title: 'Regal Cinema', image: './images/regal.jpg', description: 'One of the earliest Art Deco cinemas in India, characterised by ziggurat style stepping and strong vertical emphasis.', year: '1933', architect: 'Charles Stevens', builder: 'Framji Sidhwa', location: { center: [72.8334, 18.9279] } },
                    { id: 'museum', category: 'Victorian', title: 'CSMVS Museum', image: './images/csmvs.jpg', description: 'Indo Saracenic landmark constructed using grey Kurla basalt and yellow Malad stone.', year: '1914', architect: 'George Wittet', builder: 'Govt. of Bombay', location: { center: [72.8327, 18.9269] } },
                    { id: 'elphinstone', category: 'Victorian', title: 'Elphinstone College', image: './images/elphinstone.jpg', description: 'Victorian Gothic Revival building with pointed arches, stone detailing, and ornamental gargoyles.', year: '1871', architect: 'James Trubshawe', builder: 'Unknown', location: { center: [72.8313, 18.9265] } },
                    { id: 'sassoon', category: 'Victorian', title: 'David Sassoon Library', image: './images/sassoon.jpg', description: 'Victorian Gothic architecture defined by pointed arches, lancet windows, and symmetrical massing.', year: '1870', architect: 'Campbell & Gosling', builder: 'Scott McClelland', location: { center: [72.8316, 18.9272] } },
                    { id: 'army', category: 'Victorian', title: 'Army and Navy Building', image: './images/army-navy.jpg', description: 'Late nineteenth century Neo Classical commercial building retaining original serif signage.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8322, 18.9285] } },
                    { id: 'esplanade', category: 'Victorian', title: 'Esplanade Mansion', image: './images/esplanade.jpg', description: 'Formerly Watson\'s Hotel. One of the earliest cast iron framed buildings in the world, with exposed iron elements.', year: '1865', architect: 'Rowland Mason Ordish', builder: 'British Engineers', location: { center: [72.8311, 18.9282] } },
                    { id: 'jehangir', category: 'Modern', title: 'Jehangir Art Gallery', image: './images/jehangir.jpg', description: 'Modernist concrete structure with a distinctive cantilevered entrance.', year: '1952', architect: 'G. M. Bhuta', builder: 'Sir Cowasji Jehangir', location: { center: [72.8317, 18.9275] } },
                    { id: 'statue', category: 'Ghost Site', title: 'Kala Ghoda Statue', image: './images/placeholder.jpg', description: 'Bronze statue installed to mark the historic site of the original Black Horse after which the precinct is named.', year: '2017', architect: 'Commissioned artwork', builder: 'Kala Ghoda Association', location: { center: [72.8318, 18.9277] } },
                    { id: 'synagogue', category: 'Victorian', title: 'Keneseth Eliyahoo', image: './images/synagogue.jpg', description: 'Victorian era synagogue built for the Baghdadi Jewish community, noted for its distinctive turquoise blue façade.', year: '1884', architect: 'Unknown', builder: 'Jewish Community', location: { center: [72.8324, 18.9278] } },
                    { id: 'ropewalk', category: 'Street Furniture', title: 'Rope Walk Lane', image: './images/ropewalk.jpg', description: 'Historic lane characterised by enamel street signage, layered brickwork, and traces of nineteenth century urban fabric.', year: '19th century', architect: 'Incremental', builder: 'Multiple', location: { center: [72.8320, 18.9270] } },
                    { id: 'army-lettering', category: 'Lettering', title: 'Army and Navy Signage', image: './images/army-lettering.jpg', description: 'Original carved and painted serif lettering integrated into the building façade.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.83225, 18.92855] } },
                    { id: 'ropewalk-signs', category: 'Lettering', title: 'Rope Walk Signs', image: './images/ropewalk-lettering.jpg', description: 'Blue enamel street signage with bilingual lettering, showing material wear and layered urban history.', year: '20th century', architect: 'Municipal signage', builder: 'BMC', location: { center: [72.83205, 18.92705] } },
                    { id: 'lumiere', category: 'Ghost Site', title: 'Lumière Screening Site', image: './images/lumiere-placeholder.jpg', description: 'On July 7, 1896, the Lumière Brothers screened the first motion pictures in India here, in the atrium of Watson\'s Hotel.', year: '1896', architect: 'N/A', builder: 'Historic Event', location: { center: [72.8312, 18.9283] } },
                    { id: 'hydrant', category: 'Street Furniture', title: 'British Fire Hydrant', image: './images/hydrant.jpg', description: 'A cast-iron fire hydrant from the Bombay Municipal Corporation era, painted red. A rare survivor of Victorian infrastructure.', year: 'Late 19th C.', architect: 'BMC', builder: 'Foundry Cast', location: { center: [72.8328, 18.9275] } },
                    { id: 'pavement', category: 'Living Heritage', title: 'The Pavement Gallery', image: './images/pavement.jpg', description: 'An informal exhibition space where aspiring artists display their work on the railings of the Jehangir Art Gallery.', year: 'Ongoing', architect: 'The People', builder: 'Informal Usage', location: { center: [72.8316, 18.9276] } },
                    { id: 'booksellers', category: 'Living Heritage', title: 'Secondhand Book Sellers', image: './images/books.jpg', description: 'The lineage of street book vendors near Flora Fountain and the University, creating an intellectual corridor.', year: 'Mid 20th C.', architect: 'N/A', builder: 'Vendor Collective', location: { center: [72.8310, 18.9265] } },
                    { id: 'kerbstones', category: 'Street Furniture', title: 'Kurla Basalt Kerbstones', image: './images/kerb.jpg', description: 'Original massive blocks of grey Kurla basalt lining the pavement, contrasting with modern pavers.', year: '19th Century', architect: 'City Engineers', builder: 'Public Works', location: { center: [72.8320, 18.9270] } },
                    { id: 'rhythm', category: 'Ghost Site', title: 'Rhythm House', image: './images/rhythm-house.jpg', description: 'Formerly the city\'s premier music store (1948–2016). This curved Art Deco building hosted musicians from The Beatles to Ravi Shankar.', year: '1940s', architect: 'Unknown', builder: 'Mehmood Curmally', location: { center: [72.8317, 18.9272] } },
                    { id: 'wayside', category: 'Ghost Site', title: 'Wayside Inn', image: './images/wayside.jpg', description: 'Now the Khyber restaurant. It was in this quaint tea room that Dr. B.R. Ambedkar is said to have drafted sections of the Indian Constitution.', year: 'Early 20th C.', architect: 'N/A', builder: 'Historic Site', location: { center: [72.8320, 18.9275] } }
                ]
            };

            var consoleDiv = document.getElementById('console');
            var categories = [...new Set(config.chapters.map(function(item) { return item.category; }))];
            
            var allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.innerHTML = 'All Layers';
            allBtn.onclick = function() { filterMarkers('all', this); };
            consoleDiv.appendChild(allBtn);

            categories.forEach(function(cat) {
                var btn = document.createElement('button');
                btn.className = 'filter-btn';
                var color = config.colors[cat] || '#333';
                btn.innerHTML = '<span class="dot-indicator" style="color:' + color + '"></span> ' + cat;
                btn.onclick = function() { filterMarkers(cat, this); };
                consoleDiv.appendChild(btn);
            });

            var wallBtn = document.createElement('button');
            wallBtn.id = 'wall-btn';
            wallBtn.className = 'filter-btn';
            wallBtn.innerHTML = '<i class="fa-solid fa-archway"></i> Toggle 1860 Fort Wall';
            wallBtn.onclick = function() { toggleLayer('fort-wall-layer', this); };
            consoleDiv.appendChild(wallBtn);

            var wallInfo = document.createElement('div');
            wallInfo.id = 'wall-info';
            wallInfo.innerHTML = '<strong>The Invisible Ramparts</strong>This dashed line traces the demolished fortifications of the Bombay Fort (removed 1862). K. Dubash Marg curves specifically because it was built over this moat.';
            consoleDiv.appendChild(wallInfo);

            var map = new maplibregl.Map({
                container: 'map',
                style: config.style,
                center: [72.8325, 18.9275],
                zoom: initialZoom,
                pitch: 45, 
                bearing: -15,
                antialias: true 
            });
            
            // 1. ADD NAVIGATION + GEOLOCATE (Locate Me)
            map.addControl(new maplibregl.NavigationControl({ showCompass: true, showZoom: true }), 'top-right');
            
            // "Locate Me" Button
            var geolocate = new maplibregl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true
            });
            map.addControl(geolocate, 'top-right');

            // 2. ADD SCALE BAR (Bottom Left)
            var scale = new maplibregl.ScaleControl({
                maxWidth: 100,
                unit: 'metric'
            });
            map.addControl(scale, 'bottom-left');

            window.mapInstance = map;

            var markerObjects = [];
            var selectedMarker = null;
            var tooltip = document.getElementById('tooltip');

            map.on("load", function () {
                map.setSky({
                    'sky-color': '#87CEEB',
                    'sky-horizon-blend': 0.5,
                    'horizon-color': '#ffffff',
                    'fog-color': '#888888',
                    'fog-ground-blend': 0.5
                });

                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'openmaptiles', 
                    'source-layer': 'building',
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#f0f0f0',
                        'fill-extrusion-height': ['get', 'render_height'],
                        'fill-extrusion-base': ['get', 'render_min_height'],
                        'fill-extrusion-opacity': 0.9 
                    }
                });

                var fortWallGeoJSON = {
                    "type": "Feature",
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            [72.8312, 18.9278], [72.8318, 18.9276], [72.8325, 18.9273], [72.8335, 18.9268], [72.8342, 18.9265]
                        ]
                    }
                };

                map.addSource('fort-wall', { 'type': 'geojson', 'data': fortWallGeoJSON });
                map.addLayer({
                    'id': 'fort-wall-layer',
                    'type': 'line',
                    'source': 'fort-wall',
                    'layout': { 'line-join': 'round', 'line-cap': 'round', 'visibility': 'none' }, 
                    'paint': { 'line-color': '#c0392b', 'line-width': 4, 'line-dasharray': [2, 4] }
                });

                config.chapters.forEach(function(record) {
                    var color = config.colors[record.category] || '#333';
                    var iconClass = config.icons[record.category] || 'fa-map-marker-alt';

                    var el = document.createElement('div');
                    el.className = 'marker';
                    el.style.backgroundColor = color; 
                    el.innerHTML = '<i class="fa-solid ' + iconClass + '"></i>';

                    el.onclick = function(e) {
                        e.stopPropagation();
                        openPanel(record, color, el);
                    };

                    if (window.matchMedia('(hover: hover)').matches) {
                        el.addEventListener('mouseenter', function(e) {
                            tooltip.innerText = record.title;
                            var rect = el.getBoundingClientRect();
                            tooltip.style.left = rect.left + (rect.width / 2) + 'px';
                            tooltip.style.top = rect.top + 'px';
                            tooltip.style.opacity = '1';
                        });
                        el.addEventListener('mouseleave', function() { tooltip.style.opacity = '0'; });
                    }

                    var marker = new maplibregl.Marker({ element: el, anchor: 'bottom' })
                        .setLngLat(record.location.center)
                        .addTo(map);

                    markerObjects.push({ element: el, category: record.category, marker: marker });
                });
            });

            document.getElementById('close-btn').addEventListener('click', function() { closePanel(false); });
            
            document.getElementById('reset-btn').addEventListener('click', function() {
                map.flyTo({ center: [72.8325, 18.9275], zoom: initialZoom, pitch: 45, bearing: -15, duration: 2000 });
                closePanel(true);
            });

            // 3. 2D/3D TOGGLE BUTTON LOGIC
            var viewBtn = document.getElementById('view-btn');
            var is3D = true;
            viewBtn.classList.add('active'); // Default is 3D active

            viewBtn.addEventListener('click', function() {
                if (is3D) {
                    // Switch to 2D (Flat)
                    map.easeTo({ pitch: 0, bearing: 0 });
                    viewBtn.innerHTML = '<i class="fa-solid fa-square"></i> 2D View';
                    viewBtn.classList.remove('active');
                    is3D = false;
                } else {
                    // Switch to 3D (Angled)
                    map.easeTo({ pitch: 45, bearing: -15 });
                    viewBtn.innerHTML = '<i class="fa-solid fa-cube"></i> 3D View';
                    viewBtn.classList.add('active');
                    is3D = true;
                }
            });

            document.addEventListener('keydown', function(event) { if (event.key === "Escape") closePanel(false); });
            map.on('click', function() { closePanel(false); });

            function openPanel(record, color, markerEl) {
                if (selectedMarker) selectedMarker.classList.remove('selected');
                markerEl.classList.add('selected');
                selectedMarker = markerEl;

                var infoHTML = '<div class="panel-info">' +
                    '<div class="panel-info-row"><span class="panel-info-label">Year</span><span class="panel-info-val">' + record.year + '</span></div>' +
                    '<div class="panel-info-row"><span class="panel-info-label">Architect</span><span class="panel-info-val">' + record.architect + '</span></div>' +
                    '<div class="panel-info-row"><span class="panel-info-label">Builder</span><span class="panel-info-val">' + record.builder + '</span></div>' +
                    '</div>';

                // --- SMART DIRECTION LINK ---
                // Format: destination=Lat,Lng&travelmode=walking
                // Note: Google Maps uses Lat,Lng order.
                var destLat = record.location.center[1];
                var destLng = record.location.center[0];
                var navUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
                
                var navButton = `<a href="${navUrl}" target="_blank" class="panel-action-btn">
                                    <i class="fa-solid fa-diamond-turn-right"></i> Navigate Here
                                 </a>`;

                var panelContent = '<div class="panel-img-container"><img src="' + record.image + '" class="panel-img"></div>' +
                    '<div class="panel-content">' +
                    '<span class="panel-cat" style="color:' + color + '">' + record.category + '</span>' +
                    '<div class="panel-title">' + record.title + '</div>' +
                    '<p class="panel-desc">' + record.description + '</p>' +
                    infoHTML +
                    navButton + // ADDED BUTTON
                    '</div>';

                document.getElementById('panel-inner').innerHTML = panelContent;
                document.getElementById('side-panel').classList.add('open');

                map.flyTo({
                    center: record.location.center,
                    zoom: 17.5,
                    pitch: map.getPitch(),
                    bearing: map.getBearing(),
                    speed: 0.8,
                    curve: 1
                });
            }

            function closePanel(preventCameraMove) {
                document.getElementById('side-panel').classList.remove('open');
                if (selectedMarker) {
                    selectedMarker.classList.remove('selected');
                    selectedMarker = null;
                }
                if (!preventCameraMove) {
                    map.flyTo({ zoom: initialZoom, speed: 0.6 });
                }
            }

            function filterMarkers(selectedCat, clickedBtn) {
                var buttons = document.getElementsByClassName('filter-btn');
                for (var i = 0; i < buttons.length; i++) buttons[i].classList.remove('active');
                if(clickedBtn) clickedBtn.classList.add('active');

                markerObjects.forEach(function(m) {
                    if (selectedCat === 'all' || m.category === selectedCat) {
                        m.element.style.display = 'flex';
                        m.element.style.opacity = '1';
                    } else {
                        m.element.style.display = 'none';
                    }
                });
                if (selectedMarker && selectedMarker.style.display === 'none') closePanel(false);
            }

            window.toggleLayer = function(layerId, btn) {
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var infoBox = document.getElementById('wall-info');
                
                if (visibility === 'visible') {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                    btn.classList.remove('active');
                    infoBox.style.display = 'none';
                } else {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                    btn.classList.add('active');
                    infoBox.style.display = 'block';
                }
            };
        }
    </script>
</body>
</html>