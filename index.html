<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visual Audit: Kala Ghoda</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    
    <!-- Added Merriweather as a fallback serif for map matching -->
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        /* --- THEME: MUSEUM ARCHIVE --- */
        :root {
            --bg: #ffffff;
            --text-main: #111;
            --text-sub: #555;
            --border: #ddd;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --accent-wall: #c0392b; 
            --accent-nav: #2980b9; 
            --gold-text: #cfa842; 
        }
        
        body { margin: 0; padding: 0; font-family: 'Lato', sans-serif; overflow: hidden; background: #eee; }
        
        #map { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; transition: filter 0.5s ease; }

        body.mode-1883 #map canvas { filter: grayscale(1) contrast(0.8) brightness(1.2) !important; }
        .maplibregl-canvas-container canvas { filter: sepia(0.15) contrast(0.95); transition: filter 0.5s ease; }

        /* --- UI: HEADER --- */
        #header {
            position: absolute; top: 30px; left: 30px; 
            width: 350px; /* Slightly narrower */
            background: var(--bg);
            z-index: 100;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            border-radius: 2px; 
            max-height: 90vh;
            display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }

        #header h1 { 
            font-family: 'Cardo', serif; 
            padding: 20px 20px 5px 20px; margin: 0; 
            line-height: 1.2;
        }

        .title-sub {
            display: block; font-size: 14px; font-weight: 700;
            color: var(--text-sub); text-transform: uppercase; letter-spacing: 2px;
        }

        .title-main {
            display: block; font-size: 32px; font-weight: 400;
            color: var(--gold-text); margin-top: 5px;
            text-transform: none; 
        }

        #header h2 { 
            font-family: 'Lato', sans-serif; font-size: 10px; color: #999; 
            padding: 0 20px 15px 20px; margin: 0; text-transform: uppercase; letter-spacing: 2px; 
            font-weight: 700; border-bottom: 1px solid var(--border);
        }

        /* --- UI: SEARCH --- */
        #search-container {
            position: relative;
            padding: 10px 20px;
            transition: opacity 0.3s;
        }
        
        .search-wrapper { position: relative; display: flex; align-items: center; }

        #search-input {
            width: 100%; padding: 8px 8px 8px 30px;
            font-family: 'Lato', sans-serif; font-size: 13px;
            border: 1px solid #ccc; background: #fafafa;
            outline: none; transition: all 0.2s; border-radius: 2px;
        }
        #search-input:focus { border-color: #333; background: #fff; }
        
        .search-icon { position: absolute; left: 10px; color: #999; font-size: 12px; pointer-events: none; }

        #search-results {
            position: absolute; top: 100%; left: 20px; right: 20px;
            background: #fff; border: 1px solid var(--border); border-top: none;
            max-height: 200px; overflow-y: auto; z-index: 110; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .search-item { padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; flex-direction: column; }
        .search-item:hover { background: #f9f9f9; }
        .search-item-title { font-weight: 700; font-size: 12px; color: #333; }
        .search-item-cat { font-size: 10px; color: #888; text-transform: uppercase; margin-top: 2px; }

        /* --- UI: COLLAPSIBLE FILTERS --- */
        #console { 
            padding: 0 20px 15px 20px; 
            display: flex; flex-direction: column;
            border-top: 1px solid #f0f0f0;
        }

        #layers-header {
            padding: 12px 0; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-sub); user-select: none;
        }
        #layers-header:hover { color: var(--text-main); }
        
        #layers-arrow { transition: transform 0.3s ease; }
        #layers-arrow.rotated { transform: rotate(180deg); }

        #layers-content {
            display: flex; flex-wrap: wrap; gap: 6px; 
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            max-height: 500px; opacity: 1;
        }

        #layers-content.collapsed { max-height: 0; opacity: 0; margin-top: 0; }

        .filter-btn {
            padding: 5px 10px; font-size: 10px;
            text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;
            border: 1px solid var(--border); background: #fff; color: var(--text-sub); 
            cursor: pointer; border-radius: 2px; transition: all 0.2s ease;
            display: flex; align-items: center; gap: 5px; flex-grow: 1; justify-content: center;
        }
        .filter-btn:hover { border-color: #999; color: #000; background: #fafafa; }
        .filter-btn.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }
        
        #wall-btn, #btn-1883 { width: 100%; justify-content: center; margin-top: 4px; }
        #wall-btn.active, #btn-1883.active { background: var(--gold-text); border-color: var(--gold-text); color: #fff; }
        
        body.mode-1883 .filter-btn:not(#btn-1883) { opacity: 0.4; pointer-events: none; }
        body.mode-1883 #search-container { opacity: 0.4; pointer-events: none; }

        #wall-info {
            display: none; margin-top: 10px; padding: 10px;
            background: #f9f9f9; border-left: 3px solid var(--gold-text); 
            font-size: 11px; color: #333; line-height: 1.4;
        }
        #wall-info strong { display: block; margin-bottom: 3px; color: var(--gold-text); }

        .dot-indicator { width: 6px; height: 6px; border-radius: 50%; display: inline-block; background: currentColor; }

        /* --- UI: MARKERS --- */
        .marker {
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; 
            cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #fff; transition: transform 0.2s ease, opacity 0.3s;
            z-index: 10;
        }
        .marker:hover { transform: scale(1.15); z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .marker.selected { transform: scale(1.2); z-index: 30; box-shadow: 0 0 0 2px #fff, 0 4px 15px rgba(0,0,0,0.3); }
        
        #tooltip {
            position: absolute; pointer-events: none; background: #111; color: #fff;
            padding: 5px 10px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; border-radius: 2px; opacity: 0;
            transform: translate(-50%, -10px); transition: opacity 0.2s, transform 0.2s; 
            z-index: 500; white-space: nowrap;
        }
        @media (hover: none) { #tooltip { display: none !important; opacity: 0 !important; } }
        
        /* --- UI: SIDE PANEL --- */
        #side-panel {
            position: fixed; right: -450px; top: 0; bottom: 0; width: 400px;
            background: #fff; z-index: 200;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
            transition: right 0.6s cubic-bezier(0.19, 1, 0.22, 1); 
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        #side-panel.open { right: 0; }
        
        #panel-scroll-area { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
        .panel-img-container { position: relative; width: 100%; height: 300px; overflow: hidden; background: #eee; }
        .panel-img { width: 100%; height: 100%; object-fit: cover; filter: saturate(0.9); transition: transform 6s ease; }
        #side-panel.open .panel-img { transform: scale(1.05); } 
        .panel-content { padding: 40px; }
        
        .panel-cat { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; color: #888; margin-bottom: 15px; display: inline-block; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .panel-title { font-family: 'Cardo', serif; font-size: 32px; font-weight: 400; margin-bottom: 25px; color: var(--text-main); line-height: 1.1; }
        .panel-desc { font-size: 15px; color: #444; line-height: 1.7; margin-bottom: 40px; font-family: 'Cardo', serif; }
        .panel-info { display: table; width: 100%; border-top: 1px solid var(--border); padding-top: 20px; }
        .panel-info-row { display: table-row; }
        .panel-info-label { display: table-cell; padding: 6px 0; font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 1px; width: 30%; }
        .panel-info-val { display: table-cell; padding: 6px 0; font-size: 13px; color: #111; font-weight: 400; }

        .panel-action-btn { display: block; width: 100%; margin-top: 20px; padding: 12px 0; text-align: center; text-decoration: none; background: #fff; border: 1px solid var(--accent-nav); color: var(--accent-nav); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border-radius: 2px; transition: all 0.2s; }
        .panel-action-btn:hover { background: var(--accent-nav); color: #fff; }
        .panel-close { position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; background: rgba(255,255,255,0.9); color: #000; border: none; cursor: pointer; font-size: 20px; z-index: 300; display: flex; align-items: center; justify-content: center; transition: all 0.2s; backdrop-filter: blur(4px); border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .panel-close:hover { background: #000; color: #fff; }

        /* --- UI: VERTICAL CONTROLS --- */
        #vertical-controls { position: fixed; right: 30px; bottom: 80px; display: flex; flex-direction: column; background: #fff; box-shadow: var(--shadow); border: 1px solid var(--border); border-radius: 4px; z-index: 95; overflow: hidden; }
        .v-control-btn { width: 36px; height: 36px; border: none; background: #fff; border-bottom: 1px solid #eee; color: #333; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .v-control-btn:last-child { border-bottom: none; }
        .v-control-btn:hover { background: #f5f5f5; color: #000; }
        .v-control-btn.active-3d { background: #333; color: #fff; }
        
        .maplibregl-ctrl-top-right { display: none !important; }
        .maplibregl-ctrl-scale { background-color: rgba(255, 255, 255, 0.9) !important; border: 1px solid var(--border) !important; color: #333 !important; font-family: 'Lato', sans-serif !important; font-size: 10px !important; border-radius: 2px !important; box-shadow: none !important; }

        /* --- MOBILE OPTIMIZATION (De-clustering) --- */
        @media (max-width: 768px) {
            /* 1. Cleaner Header */
            #header { 
                top: 10px; left: 10px; right: 10px; width: auto; max-width: none; 
                background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            }
            #header h1 { padding: 15px 15px 5px 15px; }
            .title-main { font-size: 22px; margin-top: 2px; }
            /* Hide the subtitle line on mobile to save space */
            #header h2 { display: none; }
            
            #search-container { padding: 10px 15px; }
            #console { padding: 0 15px 10px 15px; }
            
            /* 2. Side Panel as Bottom Sheet (50vh) */
            #side-panel { 
                right: auto; left: 0; bottom: -100vh; top: auto; 
                width: 100%; height: 50vh; /* Reduced height to see map */
                border-left: none; border-top: 1px solid #ccc; 
                border-radius: 12px 12px 0 0; 
                box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            }
            #side-panel.open { bottom: 0; }
            .panel-content { padding: 25px; }
            .panel-img-container { height: 150px; }
            .panel-title { font-size: 22px; margin-bottom: 10px; }
            .panel-desc { font-size: 13px; margin-bottom: 20px; line-height: 1.5; }
            
            /* 3. Controls moved up to avoid overlap */
            #vertical-controls { bottom: 180px; right: 10px; }
            .maplibregl-ctrl-scale { bottom: 180px; left: 10px; }
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <div id="tooltip"></div> 
    
    <div id="header">
        <h1>
            <span class="title-sub">Visual Audit</span>
            <span class="title-main">Kala Ghoda</span>
        </h1>
        <h2>Heritage Survey</h2>
        
        <div id="search-container">
            <div class="search-wrapper">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Search..." autocomplete="off">
            </div>
            <div id="search-results"></div>
        </div>

        <div id="console">
            <div id="layers-header">
                <span><i class="fa-solid fa-layer-group"></i> Filter Layers</span>
                <i class="fa-solid fa-chevron-down" id="layers-arrow"></i>
            </div>
            
            <div id="layers-content" class="collapsed">
                <!-- JS will inject buttons here -->
            </div>
        </div>
    </div>

    <div id="vertical-controls">
        <button class="v-control-btn" id="zoom-in-btn" title="Zoom In"><i class="fa-solid fa-plus"></i></button>
        <button class="v-control-btn" id="zoom-out-btn" title="Zoom Out"><i class="fa-solid fa-minus"></i></button>
        <button class="v-control-btn" id="compass-btn" title="North"><i class="fa-regular fa-compass"></i></button>
        <button class="v-control-btn" id="view-3d-btn" title="Toggle 3D"><i class="fa-solid fa-cube"></i></button>
        <button class="v-control-btn" id="reset-view-btn" title="Reset View"><i class="fa-solid fa-compress"></i></button>
        <button class="v-control-btn" id="locate-btn" title="My Location"><i class="fa-solid fa-location-crosshairs"></i></button>
    </div>

    <div id="side-panel">
        <button class="panel-close" id="close-btn">×</button>
        <div id="panel-scroll-area">
            <div id="panel-inner"></div>
        </div>
    </div>

    <script>
        window.addEventListener('load', function() {
            initMap();
        });

        function initMap() {
            var initialZoom = window.innerWidth < 768 ? 15.0 : 16.5;

            var config = {
                style: 'https://api.maptiler.com/maps/019b6fe6-78c4-7dcb-b6eb-fed1b18171df/style.json?key=f0f0aibL2C05fTzSrqHq', 
                colors: { 'Art Deco': '#2a9d8f', 'Victorian': '#e76f51', 'Modern': '#264653', 'Lettering': '#7b2cbf', 'Ghost Site': '#95a5a6', 'Street Furniture': '#4a69bd', 'Living Heritage': '#27ae60' },
                icons: { 'Art Deco': 'fa-building', 'Victorian': 'fa-landmark', 'Modern': 'fa-square', 'Lettering': 'fa-font', 'Ghost Site': 'fa-ghost', 'Street Furniture': 'fa-road', 'Living Heritage': 'fa-users' },
                chapters: [
                    { id: 'regal', category: 'Art Deco', title: 'Regal Cinema', image: './images/regal.jpg', description: 'One of the earliest Art Deco cinemas in India.', year: '1933', architect: 'Charles Stevens', builder: 'Framji Sidhwa', location: { center: [72.8325, 18.9246] } },
                    { id: 'museum', category: 'Victorian', title: 'CSMVS Museum', image: './images/csmvs.jpg', description: 'Indo Saracenic landmark constructed using grey Kurla basalt.', year: '1914', architect: 'George Wittet', builder: 'Govt. of Bombay', location: { center: [72.8322, 18.9269] } },
                    { id: 'elphinstone', category: 'Victorian', title: 'Elphinstone College', image: './images/elphinstone.jpg', description: 'Victorian Gothic Revival building with pointed arches.', year: '1871', architect: 'James Trubshawe', builder: 'Unknown', location: { center: [72.8309, 18.9271] } },
                    { id: 'sassoon', category: 'Victorian', title: 'David Sassoon Library', image: './images/sassoon.jpg', description: 'Victorian Gothic architecture defined by pointed arches.', year: '1870', architect: 'Campbell & Gosling', builder: 'Scott McClelland', location: { center: [72.8311, 18.9277] } },
                    { id: 'army', category: 'Victorian', title: 'Army and Navy Building', image: './images/army-navy.jpg', description: 'Late nineteenth century Neo Classical commercial building.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8313, 18.9282] } },
                    { id: 'esplanade', category: 'Victorian', title: 'Esplanade Mansion', image: './images/esplanade.jpg', description: 'Formerly Watson\'s Hotel. One of the earliest cast iron framed buildings.', year: '1865', architect: 'Rowland Mason Ordish', builder: 'British Engineers', location: { center: [72.8311, 18.9283] } },
                    { id: 'jehangir', category: 'Modern', title: 'Jehangir Art Gallery', image: './images/jehangir.jpg', description: 'Modernist concrete structure with a distinctive cantilevered entrance.', year: '1952', architect: 'G. M. Bhuta', builder: 'Sir Cowasji Jehangir', location: { center: [72.8317, 18.9275] } },
                    { id: 'statue', category: 'Street Furniture', title: 'Kala Ghoda Statue', image: './images/placeholder.jpg', description: 'Bronze statue installed to mark the historic site.', year: '2017', architect: 'Commissioned artwork', builder: 'Kala Ghoda Association', location: { center: [72.8318, 18.9279] } },
                    { id: 'synagogue', category: 'Victorian', title: 'Keneseth Eliyahoo', image: './images/synagogue.jpg', description: 'Victorian era synagogue built for the Baghdadi Jewish community.', year: '1884', architect: 'Unknown', builder: 'Jewish Community', location: { center: [72.8326, 18.9281] } },
                    { id: 'ropewalk', category: 'Street Furniture', title: 'Rope Walk Lane', image: './images/ropewalk.jpg', description: 'Historic lane characterised by enamel street signage.', year: '19th century', architect: 'Incremental', builder: 'Multiple', location: { center: [72.8323, 18.9278] } },
                    { id: 'army-lettering', category: 'Lettering', title: 'Army and Navy Signage', image: './images/army-lettering.jpg', description: 'Original carved and painted serif lettering.', year: 'Late 19th C.', architect: 'Unknown', builder: 'British Military', location: { center: [72.8313, 18.9282] } },
                    { id: 'ropewalk-signs', category: 'Lettering', title: 'Rope Walk Signs', image: './images/ropewalk-lettering.jpg', description: 'Blue enamel street signage with bilingual lettering.', year: '20th century', architect: 'Municipal signage', builder: 'BMC', location: { center: [72.8323, 18.9278] } },
                    { id: 'lumiere', category: 'Ghost Site', title: 'Lumière Screening Site', image: './images/lumiere-placeholder.jpg', description: 'On July 7, 1896, the Lumière Brothers screened the first motion pictures.', year: '1896', architect: 'N/A', builder: 'Historic Event', location: { center: [72.8311, 18.9283] } },
                    { id: 'hydrant', category: 'Street Furniture', title: 'British Fire Hydrant', image: './images/hydrant.jpg', description: 'A cast-iron fire hydrant from the Bombay Municipal Corporation era.', year: 'Late 19th C.', architect: 'BMC', builder: 'Foundry Cast', location: { center: [72.8325, 18.9276] } },
                    { id: 'pavement', category: 'Living Heritage', title: 'The Pavement Gallery', image: './images/pavement.jpg', description: 'An informal exhibition space where aspiring artists display their work.', year: 'Ongoing', architect: 'The People', builder: 'Informal Usage', location: { center: [72.8316, 18.9275] } },
                    { id: 'booksellers', category: 'Living Heritage', title: 'Secondhand Book Sellers', image: './images/books.jpg', description: 'The lineage of street book vendors near Flora Fountain.', year: 'Mid 20th C.', architect: 'N/A', builder: 'Vendor Collective', location: { center: [72.8305, 18.9290] } },
                    { id: 'kerbstones', category: 'Street Furniture', title: 'Kurla Basalt Kerbstones', image: './images/kerb.jpg', description: 'Original massive blocks of grey Kurla basalt lining the pavement.', year: '19th Century', architect: 'City Engineers', builder: 'Public Works', location: { center: [72.8320, 18.9275] } },
                    { id: 'rhythm', category: 'Ghost Site', title: 'Rhythm House', image: './images/rhythm-house.jpg', description: 'Formerly the city\'s premier music store.', year: '1940s', architect: 'Unknown', builder: 'Mehmood Curmally', location: { center: [72.8318, 18.9272] } },
                    { id: 'wayside', category: 'Ghost Site', title: 'Wayside Inn', image: './images/wayside.jpg', description: 'Now the Khyber restaurant. Famous quaint tea room.', year: 'Early 20th C.', architect: 'N/A', builder: 'Historic Site', location: { center: [72.8317, 18.9286] } }
                ]
            };

            var layersContent = document.getElementById('layers-content');
            var categories = [...new Set(config.chapters.map(function(item) { return item.category; }))];
            
            var allBtn = document.createElement('button');
            allBtn.className = 'filter-btn active';
            allBtn.innerHTML = 'All Layers';
            allBtn.onclick = function() { filterMarkers('all', this); };
            layersContent.appendChild(allBtn);

            categories.forEach(function(cat) {
                var btn = document.createElement('button');
                btn.className = 'filter-btn';
                var color = config.colors[cat] || '#333';
                btn.innerHTML = '<span class="dot-indicator" style="color:' + color + '"></span> ' + cat;
                btn.onclick = function() { filterMarkers(cat, this); };
                layersContent.appendChild(btn);
            });

            var wallBtn = document.createElement('button');
            wallBtn.id = 'wall-btn';
            wallBtn.className = 'filter-btn';
            wallBtn.innerHTML = '<i class="fa-solid fa-archway"></i> Toggle 1860 Fort Wall';
            wallBtn.onclick = function() { toggleLayer('fort-wall-layer', this); };
            layersContent.appendChild(wallBtn);

            var map1883Btn = document.createElement('button');
            map1883Btn.id = 'btn-1883';
            map1883Btn.className = 'filter-btn';
            map1883Btn.innerHTML = '<i class="fa-solid fa-map-location-dot"></i> View 1883 Map';
            map1883Btn.onclick = function() { toggle1883Map(this); };
            layersContent.appendChild(map1883Btn);

            var wallInfo = document.createElement('div');
            wallInfo.id = 'wall-info';
            wallInfo.innerHTML = '<strong>The Invisible Ramparts</strong>This dashed line traces the demolished fortifications of the Bombay Fort (removed 1862).';
            layersContent.appendChild(wallInfo);

            var layersHeader = document.getElementById('layers-header');
            var layersArrow = document.getElementById('layers-arrow');
            
            layersHeader.addEventListener('click', function() {
                if (layersContent.classList.contains('collapsed')) {
                    layersContent.classList.remove('collapsed');
                    layersArrow.classList.add('rotated'); 
                } else {
                    layersContent.classList.add('collapsed');
                    layersArrow.classList.remove('rotated'); 
                }
            });

            var map = new maplibregl.Map({
                container: 'map',
                style: config.style,
                center: [72.8320, 18.9275], 
                zoom: initialZoom,
                minZoom: 14.5, 
                maxBounds: [[72.8100, 18.9100], [72.8500, 18.9450]],
                pitch: 45, bearing: -15, antialias: true, attributionControl: false
            });
            
            map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
            map.addControl(new maplibregl.ScaleControl({ maxWidth: 100, unit: 'metric' }), 'bottom-left');

            document.getElementById('zoom-in-btn').addEventListener('click', function() { map.zoomIn(); });
            document.getElementById('zoom-out-btn').addEventListener('click', function() { map.zoomOut(); });
            document.getElementById('compass-btn').addEventListener('click', function() { map.flyTo({ bearing: 0, pitch: 0 }); });
            
            var is3D = true;
            var view3dBtn = document.getElementById('view-3d-btn');
            view3dBtn.classList.add('active-3d'); 
            view3dBtn.addEventListener('click', function() {
                if (is3D) { map.easeTo({ pitch: 0, bearing: 0 }); view3dBtn.classList.remove('active-3d'); is3D = false; } 
                else { map.easeTo({ pitch: 45, bearing: -15 }); view3dBtn.classList.add('active-3d'); is3D = true; }
            });
            document.getElementById('reset-view-btn').addEventListener('click', function() { map.flyTo({ center: [72.8320, 18.9275], zoom: initialZoom, pitch: 45, bearing: -15, duration: 2000 }); is3D = true; view3dBtn.classList.add('active-3d'); closePanel(true); });
            var geolocate = new maplibregl.GeolocateControl({ positionOptions: { enableHighAccuracy: true }, trackUserLocation: true });
            map.addControl(geolocate); 
            document.getElementById('locate-btn').addEventListener('click', function() { geolocate.trigger(); });

            window.mapInstance = map;
            var markerObjects = [];
            var selectedMarker = null;
            var tooltip = document.getElementById('tooltip');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            searchInput.addEventListener('input', function(e) {
                const val = e.target.value.toLowerCase();
                if (val.length < 1) { searchResults.style.display = 'none'; return; }
                const matches = config.chapters.filter(item => item.title.toLowerCase().includes(val) || item.category.toLowerCase().includes(val));
                if (matches.length > 0) {
                    searchResults.innerHTML = ''; searchResults.style.display = 'block';
                    matches.forEach(item => {
                        const div = document.createElement('div'); div.className = 'search-item';
                        div.innerHTML = `<span class="search-item-title">${item.title}</span><span class="search-item-cat">${item.category}</span>`;
                        div.addEventListener('click', () => { const targetObj = markerObjects.find(obj => obj.id === item.id); if (targetObj) { targetObj.element.click(); searchInput.value = ''; searchResults.style.display = 'none'; } });
                        searchResults.appendChild(div);
                    });
                } else { searchResults.style.display = 'none'; }
            });
            document.addEventListener('click', function(e) { if (!document.getElementById('search-container').contains(e.target)) { searchResults.style.display = 'none'; } });

            map.on("load", function () {
                map.setSky({ 'sky-color': '#87CEEB', 'sky-horizon-blend': 0.5, 'horizon-color': '#ffffff', 'fog-color': '#888888', 'fog-ground-blend': 0.5 });
                
                // --- ATTEMPT TO STYLE MAP LABELS WITH SERIF FONTS ---
                // We iterate over layers and change text-font to Noto Serif if available
                var layers = map.getStyle().layers;
                layers.forEach(function(layer) {
                    if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                        map.setLayoutProperty(layer.id, 'text-font', ['Noto Serif Regular', 'Open Sans Regular', 'Arial Unicode MS Regular']);
                        // Note: This only works if 'Noto Serif Regular' is in the glyphs source.
                    }
                });

                // COORDINATES for 1.32 Aspect Ratio Image
                map.addSource('source-1883', {
                    'type': 'image',
                    'url': './images/fort-1883.jpg',
                    'coordinates': [
                        [72.8228, 18.9435], 
                        [72.8492, 18.9435], 
                        [72.8492, 18.9235], 
                        [72.8228, 18.9235]
                    ]
                });
                map.addLayer({ 'id': 'layer-1883', 'type': 'raster', 'source': 'source-1883', 'paint': { 'raster-fade-duration': 0 }, 'layout': { 'visibility': 'none' } });

                map.addLayer({ 'id': '3d-buildings', 'source': 'openmaptiles', 'source-layer': 'building', 'type': 'fill-extrusion', 'minzoom': 15, 'paint': { 'fill-extrusion-color': '#f0f0f0', 'fill-extrusion-height': ['get', 'render_height'], 'fill-extrusion-base': ['get', 'render_min_height'], 'fill-extrusion-opacity': 0.9 } });

                var fortWallGeoJSON = { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [[72.8312, 18.9278], [72.8318, 18.9276], [72.8325, 18.9273], [72.8335, 18.9268], [72.8342, 18.9265]] } };
                map.addSource('fort-wall', { 'type': 'geojson', 'data': fortWallGeoJSON });
                map.addLayer({ 'id': 'fort-wall-layer', 'type': 'line', 'source': 'fort-wall', 'layout': { 'line-join': 'round', 'line-cap': 'round', 'visibility': 'none' }, 'paint': { 'line-color': '#c0392b', 'line-width': 4, 'line-dasharray': [2, 4] } });

                config.chapters.forEach(function(record) {
                    var color = config.colors[record.category] || '#333';
                    var iconClass = config.icons[record.category] || 'fa-map-marker-alt';
                    var el = document.createElement('div'); el.className = 'marker'; el.style.backgroundColor = color; el.innerHTML = '<i class="fa-solid ' + iconClass + '"></i>';
                    el.onclick = function(e) { e.stopPropagation(); openPanel(record, color, el); };
                    if (window.matchMedia('(hover: hover)').matches) {
                        el.addEventListener('mouseenter', function(e) { tooltip.innerText = record.title; var rect = el.getBoundingClientRect(); tooltip.style.left = rect.left + (rect.width / 2) + 'px'; tooltip.style.top = rect.top + 'px'; tooltip.style.opacity = '1'; });
                        el.addEventListener('mouseleave', function() { tooltip.style.opacity = '0'; });
                    }
                    var marker = new maplibregl.Marker({ element: el, anchor: 'bottom' }).setLngLat(record.location.center).addTo(map);
                    markerObjects.push({ element: el, category: record.category, marker: marker, id: record.id, title: record.title });
                });
            });

            document.getElementById('close-btn').addEventListener('click', function() { closePanel(false); });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape") closePanel(false); });
            map.on('click', function() { closePanel(false); });

            function openPanel(record, color, markerEl) {
                if (selectedMarker) selectedMarker.classList.remove('selected');
                markerEl.classList.add('selected');
                selectedMarker = markerEl;
                var infoHTML = '<div class="panel-info">' + '<div class="panel-info-row"><span class="panel-info-label">Year</span><span class="panel-info-val">' + record.year + '</span></div>' + '<div class="panel-info-row"><span class="panel-info-label">Architect</span><span class="panel-info-val">' + record.architect + '</span></div>' + '<div class="panel-info-row"><span class="panel-info-label">Builder</span><span class="panel-info-val">' + record.builder + '</span></div>' + '</div>';
                var destLat = record.location.center[1]; var destLng = record.location.center[0];
                var navUrl = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
                var navButton = `<a href="${navUrl}" target="_blank" class="panel-action-btn"><i class="fa-solid fa-diamond-turn-right"></i> Navigate Here</a>`;
                var panelContent = '<div class="panel-img-container"><img src="' + record.image + '" class="panel-img"></div>' + '<div class="panel-content">' + '<span class="panel-cat" style="color:' + color + '">' + record.category + '</span>' + '<div class="panel-title">' + record.title + '</div>' + '<p class="panel-desc">' + record.description + '</p>' + infoHTML + navButton + '</div>';
                document.getElementById('panel-inner').innerHTML = panelContent; document.getElementById('side-panel').classList.add('open');
                
                // MOBILE INTERACTION FIX: Stop zooming/flying on small screens
                if (window.innerWidth >= 768) {
                    map.flyTo({ center: record.location.center, zoom: 17.5, pitch: map.getPitch(), bearing: map.getBearing(), speed: 0.8, curve: 1 });
                }
            }

            function closePanel(preventCameraMove) {
                document.getElementById('side-panel').classList.remove('open');
                if (selectedMarker) { selectedMarker.classList.remove('selected'); selectedMarker = null; }
                if (!preventCameraMove && window.innerWidth >= 768) { map.flyTo({ zoom: initialZoom, speed: 0.6 }); }
            }

            function filterMarkers(selectedCat, clickedBtn) {
                if (document.body.classList.contains('mode-1883')) return;
                var buttons = document.getElementsByClassName('filter-btn');
                for (var i = 0; i < buttons.length; i++) buttons[i].classList.remove('active');
                if(clickedBtn) clickedBtn.classList.add('active');
                markerObjects.forEach(function(m) {
                    if (selectedCat === 'all' || m.category === selectedCat) { m.element.style.display = 'flex'; m.element.style.opacity = '1'; } 
                    else { m.element.style.display = 'none'; }
                });
                if (selectedMarker && selectedMarker.style.display === 'none') closePanel(false);
            }

            window.toggleLayer = function(layerId, btn) {
                if (document.body.classList.contains('mode-1883')) return;
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var infoBox = document.getElementById('wall-info');
                if (visibility === 'visible') { map.setLayoutProperty(layerId, 'visibility', 'none'); btn.classList.remove('active'); infoBox.style.display = 'none'; } 
                else { map.setLayoutProperty(layerId, 'visibility', 'visible'); btn.classList.add('active'); infoBox.style.display = 'block'; }
            };

            window.toggle1883Map = function(btn) {
                var layerId = 'layer-1883';
                var visibility = map.getLayoutProperty(layerId, 'visibility');
                var body = document.body;
                
                if (visibility === 'visible') {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fa-solid fa-map-location-dot"></i> View 1883 Map';
                    body.classList.remove('mode-1883');
                    markerObjects.forEach(function(m) { m.element.style.display = 'flex'; });
                    var activeFilter = document.querySelector('.filter-btn.active:not(#wall-btn):not(#btn-1883)');
                    if (activeFilter) activeFilter.click(); else document.querySelector('.filter-btn').click();
                } else {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fa-solid fa-times"></i> Exit 1883 Map';
                    body.classList.add('mode-1883');
                    markerObjects.forEach(function(m) { m.element.style.display = 'none'; });
                    closePanel(true);
                    map.flyTo({ center: [72.8360, 18.9335], zoom: 14.5, pitch: 0, bearing: 0 });
                }
            };
        }
    </script>
</body>
</html>